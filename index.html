<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexagram - Ultimate Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'SimSun', serif;
            background: #000;
            color: #e8e8e8;
            overflow: hidden;
            height: 100vh;
        }

        #gameContainer {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Scene Area */
        #sceneArea {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #sceneBackground {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        #atmosphereLayer {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .atmosphere-effect {
            position: absolute;
            border-radius: 50%;
            animation: atmosphereFloat 8s ease-in-out infinite;
        }

        @keyframes atmosphereFloat {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
            50% { transform: translate(20px, -30px) scale(1.2); opacity: 0.6; }
        }

        #objectsLayer {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 3;
        }

        #groundLayer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 30%;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
            z-index: 2;
            pointer-events: none;
        }

        /* Scene Objects */
        .scene-object {
            position: absolute;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            filter: drop-shadow(0 8px 15px rgba(0,0,0,0.6));
            z-index: 10;
        }

        .scene-object:hover {
            transform: translateY(-10px) scale(1.15);
            filter: drop-shadow(0 12px 25px rgba(0,0,0,0.8)) brightness(1.3);
            z-index: 20;
        }

        .scene-object.npc {
            width: 100px;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .npc-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 4px solid #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5), 0 0 30px rgba(255, 215, 0, 0.4);
            animation: npcFloat 3s ease-in-out infinite;
        }

        @keyframes npcFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .npc-name {
            margin-top: 8px;
            font-size: 13px;
            color: #ffd700;
            text-shadow: 0 0 8px rgba(255, 215, 0, 1);
            background: rgba(0,0,0,0.8);
            padding: 4px 12px;
            border-radius: 15px;
            white-space: nowrap;
        }

        .interaction-hint {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: rgba(255, 215, 0, 0.95);
            color: #000;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .scene-object:hover .interaction-hint {
            transform: translateX(-50%) scale(1) translateY(-5px);
        }

        .scene-object.item {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 45px;
            animation: itemPulse 2.5s ease-in-out infinite;
        }

        @keyframes itemPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }

        /* Bird Flying Animation */
        .bird-flying-out {
            animation: birdFlyOut 2s ease-in-out forwards !important;
            pointer-events: none;
        }

        @keyframes birdFlyOut {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -300%) scale(0.3); opacity: 0; }
        }

        /* Flower Fade Away */
        .flower-fade-away {
            animation: flowerFadeAway 1.5s ease-out forwards !important;
            pointer-events: none;
        }

        @keyframes flowerFadeAway {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { 
                transform: translate(calc(-50% + 200px), calc(-50% - 100px)) scale(0.3) rotate(360deg); 
                opacity: 0; 
            }
        }

        /* Room Title */
        #roomTitle {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 1), 3px 3px 6px rgba(0, 0, 0, 0.9);
            z-index: 8;
            pointer-events: none;
            opacity: 0;
            animation: titleEntry 1.5s ease forwards;
            text-align: center;
            max-width: 45%;
            line-height: 1.2;
        }

        @keyframes titleEntry {
            to { opacity: 1; }
        }

        /* Hexagram Disk - 6 circles */
        #hexagramDisk {
            position: absolute;
            left: 50%;
            top: 45%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            z-index: 5;
        }

        .disk-slot {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.5s ease;
        }

        .disk-slot.filled {
            border-color: #ffd700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
        }

        /* Library Paths */
        #libraryPaths {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 40px;
            z-index: 10;
        }

        .library-path {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, rgba(100, 100, 255, 0.3), rgba(100, 100, 255, 0.1));
            border: 3px solid rgba(100, 150, 255, 0.5);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 40px;
        }

        .library-path:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(100, 150, 255, 0.8);
            background: linear-gradient(135deg, rgba(100, 100, 255, 0.5), rgba(100, 100, 255, 0.2));
        }

        .library-path.completed {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.5), rgba(255, 215, 0, 0.2));
            border-color: #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            pointer-events: none;
        }

        .library-path-name {
            font-size: 14px;
            color: #fff;
            margin-top: 8px;
            font-weight: bold;
        }

        /* Theater Stage Choices */
        #theaterChoices {
            position: absolute;
            left: 50%;
            top: 55%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 60px;
            z-index: 10;
        }

        .theater-choice {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, rgba(200, 0, 0, 0.3), rgba(200, 0, 0, 0.1));
            border: 3px solid rgba(255, 100, 100, 0.5);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 50px;
        }

        .theater-choice:hover {
            transform: scale(1.15);
            box-shadow: 0 0 40px rgba(255, 100, 100, 0.9);
            background: linear-gradient(135deg, rgba(200, 0, 0, 0.5), rgba(200, 0, 0, 0.2));
        }

        .theater-choice-name {
            font-size: 16px;
            color: #fff;
            margin-top: 10px;
            font-weight: bold;
        }

        .theater-choice.fade-out {
            animation: fadeOutScale 0.8s ease-out forwards;
        }

        @keyframes fadeOutScale {
            to { transform: scale(0); opacity: 0; }
        }

        .chosen-flower {
            animation: chosenFlowerGlow 2s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }

        @keyframes chosenFlowerGlow {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            }
        }

        /* Theater Creation Animation */
        #theaterCreation {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            display: none;
            z-index: 10;
        }

        .creation-stage {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .creation-stage.active {
            display: flex;
            animation: stageAppear 1s ease-out;
        }

        @keyframes stageAppear {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Star Creation */
        .star-small {
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 20px #fff;
            animation: starGrow 2s ease-out forwards;
        }

        @keyframes starGrow {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .star-nebula {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.8), rgba(100,150,255,0.4), transparent);
            border-radius: 50%;
            animation: nebulaExpand 2s ease-out forwards;
        }

        @keyframes nebulaExpand {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .star-galaxy {
            width: 500px;
            height: 300px;
            background: radial-gradient(ellipse, rgba(255,255,255,0.6), rgba(100,150,255,0.3), rgba(50,0,100,0.2), transparent);
            border-radius: 50%;
            animation: galaxySpiral 3s ease-out forwards;
        }

        @keyframes galaxySpiral {
            from { transform: scale(0) rotate(0deg); opacity: 0; }
            to { transform: scale(1) rotate(360deg); opacity: 1; }
        }

        /* Tree Creation */
        .tree-seed {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #8b4513, #654321);
            border-radius: 50%;
            position: relative;
            animation: seedGrow 1s ease-out forwards;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .tree-seed::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 8px;
            background: #228b22;
            border-radius: 1px;
        }

        @keyframes seedGrow {
            from { transform: scale(0) rotate(0deg); }
            to { transform: scale(1) rotate(360deg); }
        }

        .tree-growing {
            width: 120px;
            height: 280px;
            position: relative;
            animation: treeGrow 2s ease-out forwards;
        }

        .tree-growing::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 80px;
            background: linear-gradient(to top, #8b4513, #a0522d);
            border-radius: 12px 12px 0 0;
        }

        .tree-growing::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 200px;
            background: radial-gradient(ellipse at center, #228b22, #32cd32);
            clip-path: polygon(50% 0%, 20% 30%, 15% 60%, 25% 80%, 15% 100%, 85% 100%, 75% 80%, 85% 60%, 80% 30%);
            animation: leavesGrow 1.5s ease-out 0.5s both;
        }

        @keyframes treeGrow {
            from { height: 20px; opacity: 0; }
            to { height: 280px; opacity: 1; }
        }

        @keyframes leavesGrow {
            from { transform: scale(0) translateX(-50%); opacity: 0; }
            to { transform: scale(1) translateX(-50%); opacity: 1; }
        }

        .tree-blooming {
            width: 300px;
            height: 400px;
            position: relative;
            animation: treeBloom 2s ease-out forwards;
        }

        .tree-blooming::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 120px;
            background: linear-gradient(to top, #8b4513, #a0522d, #cd853f);
            border-radius: 20px 20px 0 0;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }

        .tree-blooming::after {
            content: '';
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 300px;
            background: radial-gradient(ellipse at center, #32cd32, #228b22, #006400);
            clip-path: polygon(50% 0%, 15% 25%, 10% 45%, 20% 65%, 15% 85%, 25% 100%, 75% 100%, 85% 85%, 80% 65%, 90% 45%, 85% 25%);
            box-shadow: 0 0 20px rgba(34, 139, 34, 0.3);
            animation: leavesBloom 1.5s ease-out 0.5s both;
        }

        .tree-blooming .bloom-effect {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 20%, rgba(255, 255, 0, 0.3), transparent 40%),
                        radial-gradient(circle at 70% 30%, rgba(255, 165, 0, 0.2), transparent 40%),
                        radial-gradient(circle at 50% 60%, rgba(255, 192, 203, 0.2), transparent 50%);
            animation: bloomGlow 2s ease-out 1s both;
        }

        @keyframes treeBloom {
            from { transform: scale(0.3); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes leavesBloom {
            from { transform: scale(0) translateX(-50%); opacity: 0; }
            to { transform: scale(1) translateX(-50%); opacity: 1; }
        }

        @keyframes bloomGlow {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Castle Creation */
        .castle-outline {
            width: 200px;
            height: 150px;
            border: 4px solid rgba(255,255,255,0.5);
            animation: castleOutline 1.5s ease-out forwards;
        }

        @keyframes castleOutline {
            from { opacity: 0; stroke-dashoffset: 1000; }
            to { opacity: 1; stroke-dashoffset: 0; }
        }

        .castle-building {
            width: 250px;
            height: 200px;
            background: linear-gradient(to top, #808080, #a9a9a9);
            clip-path: polygon(0% 100%, 0% 40%, 10% 40%, 10% 30%, 20% 30%, 20% 40%, 80% 40%, 80% 30%, 90% 30%, 90% 40%, 100% 40%, 100% 100%);
            animation: castleRise 2s ease-out forwards;
        }

        @keyframes castleRise {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .castle-complete {
            width: 300px;
            height: 280px;
            background: linear-gradient(to top, #708090, #b0c4de);
            clip-path: polygon(0% 100%, 0% 35%, 8% 35%, 8% 25%, 15% 25%, 15% 35%, 35% 35%, 35% 15%, 42% 15%, 42% 10%, 58% 10%, 58% 15%, 65% 15%, 65% 35%, 85% 35%, 85% 25%, 92% 25%, 92% 35%, 100% 35%, 100% 100%);
            position: relative;
            animation: castleComplete 2s ease-out forwards;
        }

        @keyframes castleComplete {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Stone Slope - Pure JavaScript Implementation */
        #stoneSlope {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
        }

        /* Progress Bar */
        #progressBar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 12px;
            border-radius: 15px;
            border: 3px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            z-index: 15;
        }

        #progressTitle {
            text-align: center;
            color: #ffd700;
            font-size: 10px;
            margin-bottom: 6px;
            font-weight: bold;
        }

        #symbolsGrid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .symbol {
            width: 35px;
            height: 35px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            font-size: 18px;
            transition: all 0.6s ease;
        }

        .symbol::before {
            content: '?';
            font-size: 14px;
            color: rgba(255, 215, 0, 0.3);
        }

        .symbol.obtained {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
            border-color: #fff;
            animation: symbolObtained 0.8s ease;
        }

        .symbol.obtained::before {
            content: none;
        }

        @keyframes symbolObtained {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.3) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        /* UI Panel */
        #uiPanel {
            width: 380px;
            background: linear-gradient(135deg, rgba(10, 10, 25, 0.98), rgba(20, 20, 40, 0.98));
            border-left: 4px solid #ffd700;
            padding: 18px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            box-shadow: -8px 0 40px rgba(0, 0, 0, 0.9);
        }

        #inventory {
            margin-bottom: 18px;
        }

        #inventory h3 {
            color: #ffd700;
            margin-bottom: 12px;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 6px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .inventory-item {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.05));
            border: 2px solid rgba(255, 215, 0, 0.5);
            padding: 10px;
            margin: 6px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .inventory-item:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.35), rgba(255, 215, 0, 0.15));
            transform: translateX(6px) scale(1.02);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
        }

        .inventory-item-icon {
            font-size: 22px;
        }

        .inventory-item-name {
            flex: 1;
            font-weight: bold;
            color: #fff;
            font-size: 13px;
        }

        #commandHistory {
            max-height: 320px;
            overflow-y: auto;
            margin-bottom: 18px;
            padding-right: 6px;
        }

        .command-entry {
            margin: 6px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 6px;
            border-left: 3px solid #ffd700;
            white-space: pre-line;
            line-height: 1.6;
            animation: messageEntry 0.4s ease;
            font-size: 12px;
        }

        @keyframes messageEntry {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .system-message { color: #4ecdc4; font-style: italic; }
        .success-message { color: #4ecdc4; }
        .error-message { color: #ff6b6b; border-left-color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .npc-dialogue { color: #ffd700; font-weight: bold; display: block; margin: 4px 0; }
        .player-dialogue { color: #ff6b6b; font-weight: bold; display: block; margin: 4px 0; }
        .hint-text { color: #a8e6cf; font-style: italic; }
        .visual-effect { color: #ffb3ba; font-style: italic; }

        #quickActions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 18px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1a2e;
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
        }

        #commandInput {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            color: #e8e8e8;
            font-size: 13px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            font-family: 'Georgia', 'SimSun', serif;
        }

        #commandInput:focus {
            outline: none;
            border-color: #ffed4e;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Dialog Modal */
        #dialogModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(10, 10, 25, 0.98), rgba(20, 20, 40, 0.98));
            border: 4px solid #ffd700;
            border-radius: 20px;
            padding: 28px;
            max-width: 580px;
            width: 85%;
            z-index: 1000;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.6);
            animation: modalEntry 0.5s ease;
        }

        @keyframes modalEntry {
            from { opacity: 0; transform: translate(-50%, -60%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        #dialogOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 999;
            backdrop-filter: blur(8px);
        }

        .dialog-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 2px solid #ffd700;
        }

        .dialog-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            border: 3px solid #ffd700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
        }

        .dialog-name {
            font-size: 1.3em;
            color: #ffd700;
            font-weight: bold;
        }

        #dialogContent {
            margin-bottom: 18px;
            line-height: 1.8;
            font-size: 1em;
            min-height: 90px;
            color: #fff;
        }

        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .dialog-btn {
            padding: 10px 22px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .dialog-btn.respond {
            background: linear-gradient(135deg, #4ecdc4, #44a8a0);
            color: white;
        }

        .dialog-btn.end {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .dialog-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        /* Navigation */
        #navigationContainer {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        .nav-button {
            position: absolute;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.5), rgba(255, 215, 0, 0.2));
            border: 3px solid #ffd700;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            transition: all 0.4s ease;
            backdrop-filter: blur(15px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
        }

        .nav-button:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 215, 0, 0.5));
            transform: scale(1.3);
            box-shadow: 0 0 35px rgba(255, 215, 0, 1);
        }

        .nav-button.north { top: 70px; left: 50%; transform: translateX(-50%); }
        .nav-button.north:hover { transform: translateX(-50%) translateY(-10px) scale(1.3); }
        .nav-button.south { bottom: 70px; left: 50%; transform: translateX(-50%); }
        .nav-button.south:hover { transform: translateX(-50%) translateY(10px) scale(1.3); }
        .nav-button.east { right: 50px; top: 50%; transform: translateY(-50%); }
        .nav-button.east:hover { transform: translateX(10px) translateY(-50%) scale(1.3); }
        .nav-button.west { left: 50px; top: 50%; transform: translateY(-50%); }
        .nav-button.west:hover { transform: translateX(-10px) translateY(-50%) scale(1.3); }

        /* Canvas */
        #particleCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 6;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 1.5s ease;
        }

        #loadingScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-hexagram {
            width: 120px;
            height: 120px;
            margin: 0 auto 40px;
            animation: hexagramRotate 4s linear infinite;
        }

        @keyframes hexagramRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .hexagram-star {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .hexagram-star::before,
        .hexagram-star::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 60px solid transparent;
            border-right: 60px solid transparent;
        }

        .hexagram-star::before {
            border-bottom: 104px solid #ffd700;
            top: 0;
        }

        .hexagram-star::after {
            border-top: 104px solid #ffd700;
            bottom: 0;
        }

        .loading-text {
            font-size: 24px;
            color: #ffd700;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Victory Celebration */
        #victoryScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            animation: victoryFadeIn 1s ease;
        }

        @keyframes victoryFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #victoryContent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            max-width: 800px;
            padding: 40px;
        }

        .victory-title {
            font-size: 4em;
            color: #ffd700;
            text-shadow: 0 0 40px rgba(255, 215, 0, 1);
            animation: victoryTitlePulse 2s ease-in-out infinite;
            margin-bottom: 30px;
        }

        @keyframes victoryTitlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .victory-message {
            font-size: 1.4em;
            line-height: 1.8;
            color: #fff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
            animation: victoryMessageFadeIn 2s ease 0.5s both;
        }

        @keyframes victoryMessageFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.4);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ffd700, #ffed4e);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div style="text-align: center;">
            <div class="loading-hexagram">
                <div class="hexagram-star"></div>
            </div>
            <div class="loading-text">🌟 Hexagram Loading... 🌟</div>
        </div>
    </div>

    <!-- Victory Screen -->
    <div id="victoryScreen">
        <div id="victoryContent">
            <div class="victory-title">🎉 恭喜通关！🎉</div>
            <div class="victory-message" id="victoryMessage"></div>
        </div>
    </div>

    <div id="gameContainer">
        <!-- Scene Area -->
        <div id="sceneArea">
            <div id="sceneBackground"></div>
            <div id="atmosphereLayer"></div>
            <div id="objectsLayer"></div>
            <div id="groundLayer"></div>
            
            <div id="roomTitle"></div>
            
            <!-- Hexagram Disk for Courtyard -->
            <div id="hexagramDisk" style="display: none;"></div>
            
            <!-- Library Paths -->
            <div id="libraryPaths" style="display: none;"></div>
            
            <!-- Theater Choices -->
            <div id="theaterChoices" style="display: none;"></div>
            
            <!-- Theater Creation Animation -->
            <div id="theaterCreation"></div>
            
            <!-- Stone Slope -->
            <div id="stoneSlope" style="display: none;"></div>
            
            <div id="progressBar">
                <div id="progressTitle">✦ Collection Progress ✦</div>
                <div id="symbolsGrid"></div>
            </div>
            
            <div id="navigationContainer"></div>
            
            <canvas id="particleCanvas"></canvas>
        </div>

        <!-- UI Panel -->
        <div id="uiPanel">
            <div id="inventory">
                <h3><span>📦</span> Inventory</h3>
                <div id="inventoryList">
                    <p class="system-message">Empty</p>
                </div>
            </div>

            <div id="quickActions">
                <button class="action-btn primary" onclick="executeCommand('look')">👁️ Look</button>
                <button class="action-btn primary" onclick="executeCommand('inventory')">🎒 Inventory</button>
                <button class="action-btn" onclick="showHelp()">❓ Help</button>
                <button class="action-btn" onclick="refreshRoom()">🔄 Refresh</button>
                <button class="action-btn" onclick="forceTheaterDisplay()" id="theaterRefreshBtn" style="display: none;">🎭 Fix Theater</button>
                <button class="action-btn danger" onclick="resetGame()">🗑️ Reset</button>
            </div>

            <div id="commandHistory"></div>

            <input type="text" id="commandInput" placeholder="💬 Enter command or click scene objects..." 
                   onkeypress="handleKeyPress(event)" autocomplete="off">
        </div>
    </div>

    <!-- Dialog Modal -->
    <div id="dialogOverlay" onclick="hideDialog()"></div>
    <div id="dialogModal">
        <div class="dialog-header">
            <div class="dialog-avatar" id="dialogAvatar"></div>
            <div class="dialog-name" id="dialogName"></div>
        </div>
        <div id="dialogContent"></div>
        <div class="dialog-buttons">
            <button class="dialog-btn respond" onclick="executeCommand('respond')">💬 Respond</button>
            <button class="dialog-btn end" onclick="closeDialog()">👋 End</button>
        </div>
    </div>

    <script src="game.js"></script>
    <script>
        // Initialize game
        let game = new HexagramGame();
        const rooms = game.rooms;
        const items = game.items;
        const npcs = game.npcs;

        // Track special states
        let libraryPathsCompleted = new Set();
        let theaterStageActive = false;
        let theaterCreationStep = 0;
        let theaterChoice = null;
        let stonePushPosition = 0;

        // NPC Visual Configurations
        const npcVisuals = {
            guide: { emoji: '🧙‍♂️', color: '#ffd700', position: { x: 70, y: 65 } },
            prisoner: { emoji: '⛓️', color: '#888', position: { x: 18, y: 68 } },
            watcher: { emoji: '👁️', color: '#666', position: { x: 50, y: 60 } },
            philosopher: { emoji: '🕯️', color: '#ffa500', position: { x: 82, y: 68 } },
            bird: { emoji: '🕊️', color: '#4ecdc4', position: { x: 50, y: 50 } },
            einstein: { emoji: '👨‍🔬', color: '#4ecdc4', position: { x: 22, y: 62 } },
            marx: { emoji: '📚', color: '#e74c3c', position: { x: 78, y: 62 } },
            red: { emoji: '🌹', color: '#ff0000', position: { x: 20, y: 60 } },
            white: { emoji: '🤍', color: '#ffffff', position: { x: 50, y: 60 } },
            purple: { emoji: '💜', color: '#9b59b6', position: { x: 80, y: 60 } }
        };

        // Item Visual Configurations
        const itemVisuals = {
            torch: { emoji: '🔦', position: { x: 28, y: 75 } },
            bird: { emoji: '🕊️', position: { x: 72, y: 52 } },
            flame_of_courage: { emoji: '🔥', position: { x: 50, y: 75 } },
            feather_of_freedom: { emoji: '🪶', position: { x: 50, y: 75 } },
            shield_of_wisdom: { emoji: '🛡️', position: { x: 50, y: 72 } },
            orb_of_creation: { emoji: '🔮', position: { x: 50, y: 75 } },
            stone_of_grit: { emoji: '🗿', position: { x: 50, y: 72 } },
            seed_of_love: { emoji: '🌱', position: { x: 50, y: 75 } },
            // hexagram_disk 不应该作为掉落物品显示
            '4 paths of wisdom': { emoji: '📖', position: { x: 50, y: 56 }, hint: 'Click to explore the paths of wisdom' },
            'big stone': { emoji: '🗿', position: { x: 50, y: 68 }, hint: 'Click to push the boulder' },
            stage: { emoji: '🎭', position: { x: 50, y: 65 }, hint: 'Click to ascend the stage' }
        };

        // Particle System
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationFrame;

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        class Particle {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.life = 1;
                this.velocity = { x: (Math.random() - 0.5) * 3, y: -Math.random() * 4 - 1 };
                this.size = Math.random() * 4 + 2;
                this.rotation = Math.random() * Math.PI * 2;
                this.rotationSpeed = (Math.random() - 0.5) * 0.1;
            }

            update() {
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.life -= 0.008;
                this.velocity.y += 0.06;
                this.rotation += this.rotationSpeed;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                if (this.type === 'star') {
                    ctx.fillStyle = '#ffffff';
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#ffffff';
                } else if (this.type === 'flame') {
                    const gradient = ctx.createLinearGradient(0, -this.size, 0, this.size);
                    gradient.addColorStop(0, '#ffff00');
                    gradient.addColorStop(0.5, '#ff6b00');
                    gradient.addColorStop(1, '#ff0000');
                    ctx.fillStyle = gradient;
                } else if (this.type === 'light') {
                    ctx.fillStyle = '#ffd700';
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#ffd700';
                } else if (this.type === 'magic') {
                    ctx.fillStyle = '#ffd700';
                    ctx.shadowBlur = 25;
                    ctx.shadowColor = '#ffd700';
                }
                
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function createParticles(type, count = 30, position = null) {
            const centerX = position ? position.x : canvas.width / 2;
            const centerY = position ? position.y : canvas.height / 2;
            
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 * i) / count + Math.random() * 0.5;
                const radius = Math.random() * 150 + 50;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                particles.push(new Particle(x, y, type));
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => {
                p.update();
                p.draw();
                return p.life > 0;
            });
            animationFrame = requestAnimationFrame(animateParticles);
        }

        animateParticles();

        // Initialize Game
        function initGame() {
            updateRoomDisplay();
            updateInventory();
            updateSymbols();
            
            const savedData = localStorage.getItem('hexagramGameSave');
            if (savedData) {
                addToHistory("🌟 Welcome back! Your progress has been restored.", "system-message");
            } else {
                addToHistory("🌟 Welcome to the Hexagram! You awaken in the Courtyard of Light.", "system-message");
            }
            addToHistory("💡 Click on scene objects to interact, or enter commands below.", "system-message");
            addToHistory("💡 In the cave, you can double-click the flashlight in your inventory to use it!", "system-message");
            addToHistory("💡 In the forest, you can double-click the bird in your inventory to release it!", "system-message");
            
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 2000);
        }

        // Reset Game
        function resetGame() {
            if (confirm("确定要重置游戏吗？所有进度都将丢失。")) {
                const result = game.resetGame();
                document.getElementById('commandHistory').innerHTML = '';
                particles = [];
                libraryPathsCompleted.clear();
                theaterStageActive = false;
                theaterCreationStep = 0;
                theaterChoice = null;
                stonePushPosition = 0;
                updateRoomDisplay();
                updateInventory();
                updateSymbols();
                addToHistory(result.message, "system-message");
                addToHistory("🌟 Welcome to the Hexagram! You awaken in the Courtyard of Light.", "system-message");
                createParticles('light', 40);
            }
        }

        // Update Room Display
        function updateRoomDisplay() {
            // 确保DOM元素存在
            const room = rooms[game.gameState.currentRoom];
            const bg = document.getElementById('sceneBackground');
            const title = document.getElementById('roomTitle');
            const objectsLayer = document.getElementById('objectsLayer');
            
            if (!room || !bg || !title || !objectsLayer) {
                console.error('Critical DOM elements missing, retrying in 100ms');
                setTimeout(() => updateRoomDisplay(), 100);
                return;
            }
            
            bg.style.background = room.background;
            title.textContent = room.title;
            title.style.animation = 'none';
            setTimeout(() => {
                title.style.animation = 'titleEntry 1.5s ease forwards';
            }, 10);
            
            // 显示/隐藏theater修复按钮
            const theaterRefreshBtn = document.getElementById('theaterRefreshBtn');
            if (theaterRefreshBtn) {
                if (game.gameState.currentRoom === 'theater') {
                    theaterRefreshBtn.style.display = 'inline-block';
                } else {
                    theaterRefreshBtn.style.display = 'none';
                }
            }
            
            // 显示/隐藏library修复按钮
            const libraryRefreshBtn = document.getElementById('libraryRefreshBtn');
            if (libraryRefreshBtn) {
                if (game.gameState.currentRoom === 'library') {
                    libraryRefreshBtn.style.display = 'inline-block';
                } else {
                    libraryRefreshBtn.style.display = 'none';
                }
            }
            
            createAtmosphereEffects(game.gameState.currentRoom);
            
            // Hide all special UI elements
            document.getElementById('hexagramDisk').style.display = 'none';
            document.getElementById('libraryPaths').style.display = 'none';
            document.getElementById('theaterChoices').style.display = 'none';
            document.getElementById('theaterCreation').style.display = 'none';
            document.getElementById('stoneSlope').style.display = 'none';
            
            // 清理所有掉落物品元素（这些是直接添加到body上的）
            const dropElements = ['stoneDrop', 'seedDrop', 'orbDrop', 'shieldDrop'];
            dropElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`🧹 Removing drop element: ${id}`);
                    element.remove();
                }
            });
            
            // 清理剧院特有的元素
            const theaterElements = document.querySelectorAll('[data-item-id="stage"]');
            theaterElements.forEach(element => {
                console.log('🧹 Removing theater stage element');
                element.remove();
            });
            
            // 清理剧院选择容器内容
            const theaterChoices = document.getElementById('theaterChoices');
            if (theaterChoices) {
                theaterChoices.innerHTML = '';
                console.log('🧹 Cleared theater choices content');
            }
            
            // 清理剧院创作容器内容
            const theaterCreation = document.getElementById('theaterCreation');
            if (theaterCreation) {
                theaterCreation.innerHTML = '';
                console.log('🧹 Cleared theater creation content');
            }
            
            // 重置剧院状态变量
            theaterStageActive = false;
            theaterChoice = null;
            theaterCreationStep = 0;
            console.log('🧹 Reset theater state variables');
            
            // Clear objects - 但保存花园中被选中的花朵
            let savedChosenFlower = null;
            
            // 如果在花园且有花朵被选中，保存被选中的花朵卡片
            if (game.gameState.currentRoom === 'garden' && game.gameState.gardenRoseChosen) {
                const cards = objectsLayer.querySelectorAll('.garden-rose-card');
                const chosenRose = game.gameState.gardenRoseChosen;
                cards.forEach(card => {
                    const cardIndex = Array.from(cards).indexOf(card);
                    const isChosen = (chosenRose === 'red' && cardIndex === 0) ||
                                   (chosenRose === 'white' && cardIndex === 1) ||
                                   (chosenRose === 'purple' && cardIndex === 2);
                    if (isChosen) {
                        savedChosenFlower = card.cloneNode(true);
                        // 重新绑定点击事件（clone不会复制事件监听器）
                        savedChosenFlower.onclick = null; // 已选中的花不需要点击
                    }
                });
            }
            
            // 强制清除所有内容
            objectsLayer.innerHTML = '';
            
            // 确保objectsLayer可见
            objectsLayer.style.display = 'block';
            objectsLayer.style.visibility = 'visible';
            
            // 如果保存了被选中的花朵，立即恢复它
            if (savedChosenFlower) {
                objectsLayer.appendChild(savedChosenFlower);
            }
            
            // Special room handling
            if (game.gameState.currentRoom === 'courtyard_start') {
                showHexagramDisk();
            } else if (game.gameState.currentRoom === 'courtyard_finale') {
                // 只有在没有六芒星圆圈时才创建
                const existingCircles = document.querySelectorAll('.disk-slot');
                if (existingCircles.length === 0) {
                    showHexagramCircles();
                }
            } else if (game.gameState.currentRoom === 'library') {
                console.log('📚 In library room');
                console.log('📚 Has shield_of_wisdom:', game.gameState.inventory.includes('shield_of_wisdom'));
                console.log('📚 Library paths completed:', game.gameState.libraryPaths.size);
                console.log('📚 objectsLayer exists:', !!document.getElementById('objectsLayer'));
                console.log('📚 objectsLayer children count:', document.getElementById('objectsLayer')?.children.length || 0);
                
                if (!game.gameState.inventory.includes('shield_of_wisdom')) {
                    console.log('📚 Showing library paths');
                showLibraryPaths();
                    
                    // 验证路径是否成功添加
                    setTimeout(() => {
                        const libraryPaths = document.getElementById('libraryPaths');
                        console.log('📚 Library paths element created:', !!libraryPaths);
                        if (!libraryPaths) {
                            console.log('📚 Library paths failed to create, retrying...');
                            showLibraryPaths();
                        }
                    }, 10);
                } else {
                    console.log('📚 Shield already obtained, not showing paths');
                    // 即使已经获得盾牌，也要确保有内容显示
                    // 检查是否有其他内容，如果没有则强制显示
                    const objectsLayer = document.getElementById('objectsLayer');
                    if (objectsLayer && objectsLayer.children.length === 0) {
                        console.log('📚 Library room empty after shield obtained, forcing display...');
                        forceLibraryDisplay();
                    }
                }
            } else if (game.gameState.currentRoom === 'theater') {
                console.log('🎭 In theater room');
                console.log('🎭 Theater conditions:', {
                    einstein: game.gameState.theaterTalked.has('einstein'),
                    marx: game.gameState.theaterTalked.has('marx'),
                    hasOrb: game.gameState.inventory.includes('orb_of_creation'),
                    stageActive: theaterStageActive
                });
                
                // 如果已经获得orb，确保orb元素被移除
                if (game.gameState.inventory.includes('orb_of_creation')) {
                    console.log('🎭 Orb already obtained, removing any existing orb elements');
                    const orbDrop = document.getElementById('orbDrop');
                    if (orbDrop) {
                        console.log('🎭 Removing existing orb drop element');
                        orbDrop.remove();
                    }
                    const orbItems = document.querySelectorAll('[data-item-id="orb_of_creation"]');
                    orbItems.forEach(item => {
                        console.log('🎭 Removing existing orb item element');
                        item.remove();
                    });
                }
                
                // 如果已经与两个NPC对话过且没有获得orb，显示舞台
                if (game.gameState.theaterTalked.has('einstein') && 
                       game.gameState.theaterTalked.has('marx') &&
                       !game.gameState.inventory.includes('orb_of_creation') &&
                       !theaterStageActive) {
                    console.log('🎭 Theater conditions met, creating stage icon');
                    createTheaterStageIcon();
                } else {
                    console.log('🎭 Theater conditions not met for stage display:', {
                        einstein: game.gameState.theaterTalked.has('einstein'),
                        marx: game.gameState.theaterTalked.has('marx'),
                        hasOrb: game.gameState.inventory.includes('orb_of_creation'),
                        stageActive: theaterStageActive
                    });
                }
            } else if (game.gameState.currentRoom === 'stone_circle' && !game.gameState.inventory.includes('stone_of_grit')) {
                showStoneSlope();
            } else if (game.gameState.currentRoom === 'garden') {
                console.log('🌹 In garden room, gardenRoseChosen:', game.gameState.gardenRoseChosen);
                if (game.gameState.gardenRoseChosen) {
                    showGardenPlanting();
                } else {
                    // 总是显示选择按钮，让玩家可以选择
                    console.log('🌹 Showing garden choice buttons');
                    showGardenChoiceButtons();
                }
            }
            
            // Add NPCs
            room.npcs.forEach(npcId => {
                const npcData = npcVisuals[npcId];
                if (npcData) {
                    // 特殊处理：花园中的玫瑰，使用卡片设计而不是NPC
                    if (game.gameState.currentRoom === 'garden') {
                        // 跳过所有玫瑰NPC的创建，因为使用卡片设计
                        if (npcId === 'red' || npcId === 'white' || npcId === 'purple') {
                            return;
                        }
                    }
                    
                    console.log(`Creating NPC: ${npcId}`, npcData);
                    const npcEl = createNPC(npcId, npcData);
                    document.getElementById('objectsLayer').appendChild(npcEl);
                } else {
                    console.warn(`No NPC data found for: ${npcId}`);
                }
            });
            
            // Add Items (except special ones handled above)
            room.items.forEach(itemId => {
                if (itemId === '4 paths of wisdom' && game.gameState.currentRoom === 'library') {
                    // Handled by showLibraryPaths
                    return;
                }
                if (itemId === 'stage' && game.gameState.currentRoom === 'theater') {
                    // Stage is not a clickable item, just run 'stage' command
                    return;
                }
                if (itemId === 'big stone' && game.gameState.currentRoom === 'stone_circle') {
                    // Handled by showStoneSlope
                    return;
                }
                if (itemId === 'stone_of_grit' && game.gameState.currentRoom === 'stone_circle') {
                    // 如果已经有掉落石头，不显示
                    if (document.getElementById('stoneDrop')) {
                        return;
                    }
                    // 如果背包中已经有这个物品，不显示
                    if (game.gameState.inventory.includes('stone_of_grit')) {
                        return;
                    }
                    // 不在这里显示石头，由showStoneDrop函数处理
                    return;
                }
                if (itemId === 'seed_of_love' && game.gameState.currentRoom === 'garden') {
                    // 如果已经有掉落种子，不显示
                    if (document.getElementById('seedDrop')) {
                        return;
                    }
                    // 如果背包中已经有这个物品，不显示
                    if (game.gameState.inventory.includes('seed_of_love')) {
                        return;
                    }
                    // 不在这里显示种子，由showSeedDrop函数处理
                    return;
                }
                if (itemId === 'hexagram_disk' && (game.gameState.currentRoom === 'courtyard_start' || game.gameState.currentRoom === 'courtyard_finale')) {
                    // Handled by showHexagramDisk/showHexagramCircles - don't show as item
                    return;
                }
                
                const itemData = itemVisuals[itemId];
                if (itemData) {
                    const itemEl = createItem(itemId, itemData);
                    document.getElementById('objectsLayer').appendChild(itemEl);
                }
            });
            
            // Special: Bird in forest after release
            if (game.gameState.currentRoom === 'forest' && 
                game.gameState.birdReleased && 
                !game.gameState.forestBirdEncouraged) {
                console.log('🐦 Creating bird in forest:', {
                    currentRoom: game.gameState.currentRoom,
                    birdReleased: game.gameState.birdReleased,
                    forestBirdEncouraged: game.gameState.forestBirdEncouraged
                });
                const birdData = { emoji: '🕊️', color: '#4ecdc4', position: { x: 50, y: 50 } };
                const birdEl = createNPC('bird', birdData);
                birdEl.id = 'releasedBird';
                document.getElementById('objectsLayer').appendChild(birdEl);
            } else if (game.gameState.currentRoom === 'forest' && 
                       game.gameState.birdReleased && 
                       game.gameState.forestBirdEncouraged) {
                console.log('🐦 Bird should not be created (forestBirdEncouraged is true)');
            }
            
            updateNavigationButtons();
            createAmbientParticles(game.gameState.currentRoom);
        }

        // Show Hexagram Disk
        function showHexagramDisk() {
            const disk = document.getElementById('hexagramDisk');
            disk.style.display = 'block';
            disk.innerHTML = '';
            
            const symbolsList = [
                { id: 'flame_of_courage', emoji: '🔥' },
                { id: 'feather_of_freedom', emoji: '🪶' },
                { id: 'shield_of_wisdom', emoji: '🛡️' },
                { id: 'orb_of_creation', emoji: '🔮' },
                { id: 'stone_of_grit', emoji: '🪨' },
                { id: 'seed_of_love', emoji: '🌱' }
            ];
            
            // Position slots in a circle
            symbolsList.forEach((symbol, index) => {
                const angle = (index * 60 - 90) * Math.PI / 180; // Start from top
                const radius = 95;
                const x = 125 + radius * Math.cos(angle);
                const y = 125 + radius * Math.sin(angle);
                
                const slot = document.createElement('div');
                slot.className = 'disk-slot';
                slot.style.left = `${x - 30}px`;
                slot.style.top = `${y - 30}px`;
                slot.dataset.symbolId = symbol.id;
                
                if (game.gameState.inventory.includes(symbol.id)) {
                    slot.classList.add('filled');
                    slot.textContent = symbol.emoji;
                }
                
                disk.appendChild(slot);
            });
        }

        // Show Library Paths
        function showLibraryPaths() {
            console.log('📚 showLibraryPaths called');
            // 清除可能存在的旧路径
            const existingPaths = document.getElementById('libraryPaths');
            if (existingPaths) {
                console.log('📚 Removing existing paths');
                existingPaths.remove();
            }
            
            // 创建路径容器 - 去掉大背景框
            const container = document.createElement('div');
            container.id = 'libraryPaths';
            container.style.position = 'absolute';
            container.style.left = '50%';
            container.style.top = '50%';
            container.style.transform = 'translate(-50%, -50%)';
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(2, 1fr)';
            container.style.gap = '30px';
            container.style.padding = '20px';
            container.style.zIndex = '20';
            
            const paths = [
                { id: 'learn', emoji: '📚', name: 'Learning', command: 'learn' },
                { id: 'live', emoji: '🌍', name: 'Living', command: 'live' },
                { id: 'dialogue', emoji: '💬', name: 'Dialogue', command: 'dialogue' },
                { id: 'reflect', emoji: '🤔', name: 'Thinking', command: 'reflect' }
            ];
            
            paths.forEach(path => {
                const pathEl = document.createElement('div');
                pathEl.className = 'library-path';
                pathEl.style.display = 'flex';
                pathEl.style.flexDirection = 'column';
                pathEl.style.alignItems = 'center';
                pathEl.style.justifyContent = 'center';
                pathEl.style.padding = '25px';
                pathEl.style.borderRadius = '20px';
                pathEl.style.cursor = 'pointer';
                pathEl.style.transition = 'all 0.3s ease';
                pathEl.style.border = '3px solid #ffd700';
                pathEl.style.background = game.gameState.libraryPaths.has(path.command) 
                    ? 'rgba(255, 215, 0, 0.2)' 
                    : 'rgba(0, 0, 0, 0.6)';
                pathEl.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.4)';
                
                if (game.gameState.libraryPaths.has(path.command)) {
                    pathEl.classList.add('completed');
                    pathEl.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.6)';
                }
                
                pathEl.innerHTML = `
                    <div style="font-size: 40px; margin-bottom: 10px;">${path.emoji}</div>
                    <div style="color: #ffd700; font-weight: bold; font-size: 16px;">${path.name}</div>
                `;
                
                pathEl.onclick = () => {
                    if (!game.gameState.libraryPaths.has(path.command)) {
                        executeCommand(path.command);
                    }
                };
                
                pathEl.onmouseover = () => {
                    if (!game.gameState.libraryPaths.has(path.command)) {
                        pathEl.style.transform = 'scale(1.05)';
                        pathEl.style.boxShadow = '0 0 25px rgba(255, 215, 0, 0.8)';
                    }
                };
                
                pathEl.onmouseout = () => {
                    if (!game.gameState.libraryPaths.has(path.command)) {
                        pathEl.style.transform = 'scale(1)';
                        pathEl.style.boxShadow = 'none';
                    }
                };
                
                container.appendChild(pathEl);
            });
            
            // 将容器添加到场景中
            document.getElementById('objectsLayer').appendChild(container);
            console.log('📚 Library paths container added to objectsLayer');
            
            // Check if all paths completed, show shield forming animation
            if (game.gameState.libraryPaths.size === 4 && !game.gameState.inventory.includes('shield_of_wisdom')) {
                setTimeout(() => {
                    container.style.display = 'none';
                    showShieldFormation();
                }, 1000);
            }
        }

        // Show Shield Formation
        function showShieldFormation() {
            // Create shield in center
            const shield = document.createElement('div');
            shield.style.position = 'absolute';
            shield.style.left = '50%';
            shield.style.top = '50%';
            shield.style.transform = 'translate(-50%, -50%) scale(0)';
            shield.style.fontSize = '120px';
            shield.textContent = '🛡️';
            shield.style.zIndex = '15';
            shield.style.filter = 'drop-shadow(0 0 30px rgba(255,215,0,1))';
            shield.style.animation = 'shieldForm 2s ease-out forwards';
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shieldForm {
                    0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
                    70% { transform: translate(-50%, -50%) scale(1.3) rotate(180deg); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1) rotate(360deg); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.getElementById('objectsLayer').appendChild(shield);
            createParticles('light', 50);
            
            setTimeout(() => {
                shield.remove();
                // 只有在背包中没有盾牌且没有拾取过盾牌时才添加到房间物品列表
                const room = game.rooms[game.gameState.currentRoom];
                if (room && !room.items.includes('shield_of_wisdom') && 
                    !game.gameState.inventory.includes('shield_of_wisdom') && 
                    !game.gameState.shieldPickedUp) {
                    room.items.push('shield_of_wisdom');
                updateRoomDisplay(); // Show shield as item to pick up
                } else if (game.gameState.inventory.includes('shield_of_wisdom') || game.gameState.shieldPickedUp) {
                    console.log('🛡️ Shield already collected, not adding to room items');
                }
            }, 2500);
        }

        // Show Theater Choices
        function showTheaterChoices() {
            const container = document.getElementById('theaterChoices');
            container.style.display = 'flex';
            container.innerHTML = '';
            
            const choices = [
                { id: 'star', emoji: '⭐', name: 'Star' },
                { id: 'tree', emoji: '🌳', name: 'Tree' },
                { id: 'castle', emoji: '🏰', name: 'Castle' }
            ];
            
            choices.forEach(choice => {
                const choiceEl = document.createElement('div');
                choiceEl.className = 'theater-choice';
                choiceEl.innerHTML = `
                    <div style="font-size: 50px;">${choice.emoji}</div>
                    <div class="theater-choice-name">${choice.name}</div>
                `;
                choiceEl.onclick = (e) => {
                    e.stopPropagation();
                    const choice = choiceEl.querySelector('.theater-choice-name').textContent.toLowerCase();
                    if (choice === 'star') {
                        executeCommand('create star');
                    } else if (choice === 'tree') {
                        executeCommand('create tree');
                    } else if (choice === 'castle') {
                        executeCommand('create castle');
                    }
                };
                container.appendChild(choiceEl);
            });
        }

        // Hide Theater Choices with animation
        function hideTheaterChoices() {
            const choices = document.querySelectorAll('.theater-choice');
            choices.forEach(choice => {
                choice.classList.add('fade-out');
            });
            setTimeout(() => {
                document.getElementById('theaterChoices').style.display = 'none';
            }, 800);
        }

        // Get Creation Message
        function getCreationMessage(choice, step) {
            const messages = {
                star: {
                    1: "A lonely speck of light appears on the dome, faint yet stubbornly shining.",
                    2: "The speck expands into a nebula; stars breathe, lighting up the surroundings.",
                    3: "A vast galaxy spans the stage; the theater becomes endless cosmos.\n(Symbol: Infinity · Exploration · Imagination)"
                },
                tree: {
                    1: "A tiny seed emerges at center stage, resting quietly in the soil.",
                    2: "The seed cracks; a sprout stretches as branches unfold upward.",
                    3: "A great tree, lush with life, silhouettes the curtain with vigor.\n(Symbol: Life · Growth · Rootedness · Creation)"
                },
                castle: {
                    1: "Scattered stones appear on the ground, alone in the empty space.",
                    2: "The stones stack; towers and walls rise in measured order.",
                    3: "A grand castle stands complete upon the curtain.\n(Symbol: Construction · Will · Order · Dream)"
                }
            };
            return messages[choice][step];
        }

        // Show Theater Creation Animation
        function showTheaterCreation(choice, step) {
            const container = document.getElementById('theaterCreation');
            container.style.display = 'block';
            container.innerHTML = '';
            
            const stage = document.createElement('div');
            stage.className = 'creation-stage active';
            
            if (choice === 'star') {
                if (step === 1) {
                    stage.innerHTML = '<div class="star-small"></div>';
                } else if (step === 2) {
                    stage.innerHTML = '<div class="star-nebula"></div>';
                } else if (step === 3) {
                    stage.innerHTML = '<div class="star-galaxy"></div>';
                }
            } else if (choice === 'tree') {
                if (step === 1) {
                    stage.innerHTML = '<div class="tree-seed"></div>';
                } else if (step === 2) {
                    stage.innerHTML = '<div class="tree-growing"></div>';
                } else if (step === 3) {
                    stage.innerHTML = '<div class="tree-blooming"><div class="bloom-effect"></div></div>';
                }
            } else if (choice === 'castle') {
                if (step === 1) {
                    stage.innerHTML = '<div class="castle-outline"></div>';
                } else if (step === 2) {
                    stage.innerHTML = '<div class="castle-building"></div>';
                } else if (step === 3) {
                    stage.innerHTML = '<div class="castle-complete"></div>';
                }
            }
            
            container.appendChild(stage);
            
            // Add continue button for steps 1 and 2
            if (step < 3) {
                const continueButton = document.createElement('div');
                continueButton.className = 'theater-continue-button';
                continueButton.style.position = 'absolute';
                continueButton.style.left = '50%';
                continueButton.style.top = '80%';
                continueButton.style.transform = 'translateX(-50%)';
                continueButton.style.width = '180px';
                continueButton.style.height = '60px';
                continueButton.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                continueButton.style.border = '2px solid #ff6b6b';
                continueButton.style.borderRadius = '30px';
                continueButton.style.display = 'flex';
                continueButton.style.alignItems = 'center';
                continueButton.style.justifyContent = 'center';
                continueButton.style.cursor = 'pointer';
                continueButton.style.fontSize = '18px';
                continueButton.style.fontWeight = 'bold';
                continueButton.style.color = '#1a1a2e';
                continueButton.style.boxShadow = '0 8px 25px rgba(255, 107, 107, 0.4), 0 0 0 1px rgba(255, 107, 107, 0.2)';
                continueButton.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                continueButton.style.zIndex = '15';
                continueButton.style.fontFamily = 'Georgia, serif';
                continueButton.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.1)';
                continueButton.style.letterSpacing = '0.5px';
                
                // 创建按钮内容
                const buttonContent = document.createElement('div');
                buttonContent.style.display = 'flex';
                buttonContent.style.alignItems = 'center';
                buttonContent.style.gap = '8px';
                
                // 创建图标
                const icon = document.createElement('div');
                icon.style.width = '24px';
                icon.style.height = '24px';
                icon.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
                icon.style.borderRadius = '6px';
                icon.style.display = 'flex';
                icon.style.alignItems = 'center';
                icon.style.justifyContent = 'center';
                icon.style.fontSize = '14px';
                icon.style.color = 'white';
                icon.style.boxShadow = 'inset 0 1px 2px rgba(0, 0, 0, 0.2)';
                icon.textContent = '⏭️';
                
                // 创建文字
                const text = document.createElement('div');
                text.style.display = 'flex';
                text.style.flexDirection = 'column';
                text.style.alignItems = 'center';
                text.style.lineHeight = '1.2';
                
                const line1 = document.createElement('div');
                line1.textContent = 'Continue';
                line1.style.fontSize = '16px';
                line1.style.fontWeight = 'bold';
                
                const line2 = document.createElement('div');
                line2.textContent = 'Creating';
                line2.style.fontSize = '14px';
                line2.style.fontWeight = '600';
                line2.style.opacity = '0.9';
                
                text.appendChild(line1);
                text.appendChild(line2);
                
                buttonContent.appendChild(icon);
                buttonContent.appendChild(text);
                continueButton.appendChild(buttonContent);
                
                continueButton.onclick = () => {
                    executeCommand('continue');
                };
                
                continueButton.onmouseover = () => {
                    continueButton.style.transform = 'translateX(-50%) scale(1.08)';
                    continueButton.style.boxShadow = '0 12px 35px rgba(255, 107, 107, 0.6), 0 0 0 1px rgba(255, 107, 107, 0.3)';
                    continueButton.style.background = 'linear-gradient(135deg, #ffed4e, #ffd700)';
                };
                
                continueButton.onmouseout = () => {
                    continueButton.style.transform = 'translateX(-50%) scale(1)';
                    continueButton.style.boxShadow = '0 8px 25px rgba(255, 107, 107, 0.4), 0 0 0 1px rgba(255, 107, 107, 0.2)';
                    continueButton.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                };
                
                container.appendChild(continueButton);
            }
            
            // If final step, drop orb
            if (step === 3) {
                setTimeout(() => {
                    container.style.display = 'none';
                    showOrbDrop();
                    addToHistory("The stage light converges at your feet. Your vision crystallizes into a radiant orb.\n(Type 'take orb' to claim your reward.)", 'success-message');
                    // Add orb to room
                    const room = rooms[game.gameState.currentRoom];
                    if (!room.items.includes('orb_of_creation')) {
                        room.items.push('orb_of_creation');
                    }
                    theaterStageActive = false;
                    theaterChoice = null;
                    theaterCreationStep = 0;
                    updateRoomDisplay();
                }, 3000);
            }
        }

        // Show Orb Drop
        function showOrbDrop() {
            console.log('🔮 Creating orb drop animation and clickable item');
            
            // 创建动画效果的orb
            const orb = document.createElement('div');
            orb.style.position = 'absolute';
            orb.style.left = '50%';
            orb.style.top = '20%';
            orb.style.transform = 'translateX(-50%)';
            orb.style.fontSize = '80px';
            orb.textContent = '🔮';
            orb.style.zIndex = '15';
            orb.style.animation = 'orbDrop 2s ease-out forwards';
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes orbDrop {
                    0% { transform: translateX(-50%) translateY(-100px); opacity: 0; }
                    100% { transform: translateX(-50%) translateY(300px); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.getElementById('objectsLayer').appendChild(orb);
            
            // 动画完成后，创建可点击的orb物品
            setTimeout(() => {
                console.log('🔮 Animation completed, creating clickable orb item');
                
                // 移除动画orb
                orb.remove();
                
                // 创建可点击的orb物品
                const clickableOrb = document.createElement('div');
                clickableOrb.id = 'orbDrop';
                clickableOrb.className = 'scene-object item';
                clickableOrb.style.position = 'absolute';
                clickableOrb.style.left = '50%';
                clickableOrb.style.top = '75%';
                clickableOrb.style.transform = 'translate(-50%, -50%)';
                clickableOrb.style.fontSize = '60px';
                clickableOrb.style.cursor = 'pointer';
                clickableOrb.style.zIndex = '15';
                clickableOrb.textContent = '🔮';
                clickableOrb.setAttribute('data-item-id', 'orb_of_creation');
                clickableOrb.title = 'Click to pick up';
                clickableOrb.setAttribute('data-tooltip', 'Click to pick up');
                
                // 添加悬停提示
                const hint = document.createElement('div');
                hint.className = 'interaction-hint';
                hint.textContent = '✋ Click to pick up';
                clickableOrb.appendChild(hint);
                
                // 添加点击事件
                clickableOrb.onclick = (e) => {
                    e.stopPropagation();
                    console.log('🔮 Orb clicked, executing take command');
                    executeCommand('take orb');
                };
                
                // 添加到屏幕
                document.getElementById('objectsLayer').appendChild(clickableOrb);
                console.log('🔮 Clickable orb item created and added to screen');
                
                // 添加粒子效果
                createParticles('magic', 20, {
                    x: clickableOrb.offsetLeft + clickableOrb.offsetWidth / 2,
                    y: clickableOrb.offsetTop + clickableOrb.offsetHeight / 2
                });
                
            }, 2000); // 等待动画完成
            
            // 添加初始粒子效果
            createParticles('magic', 60);
        }

        // Show Stone Slope - IMAGE STATE SYSTEM
        function showStoneSlope() {
            const slopeContainer = document.getElementById('stoneSlope');
            slopeContainer.style.display = 'block';
            slopeContainer.innerHTML = '';
            
            // 获取屏幕尺寸
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const centerX = screenWidth / 2;
            const centerY = screenHeight / 2;
            
            // 创建大山 - 固定位置
            const mountain = document.createElement('div');
            mountain.id = 'mountain';
            mountain.textContent = '⛰️';
            mountain.style.position = 'absolute';
            mountain.style.left = (centerX - 400) + 'px';
            mountain.style.top = (centerY - 400) + 'px';
            mountain.style.width = '800px';
            mountain.style.height = '800px';
            mountain.style.fontSize = '800px';
            mountain.style.lineHeight = '800px';
            mountain.style.textAlign = 'center';
            mountain.style.zIndex = '5';
            mountain.style.filter = 'drop-shadow(0 0 40px rgba(139, 69, 19, 0.8))';
            mountain.style.pointerEvents = 'none';
            
            // 创建石头状态容器
            const stoneContainer = document.createElement('div');
            stoneContainer.id = 'stoneContainer';
            stoneContainer.style.position = 'absolute';
            stoneContainer.style.left = (centerX - 40) + 'px';
            stoneContainer.style.top = (centerY - 40) + 'px';
            stoneContainer.style.width = '80px';
            stoneContainer.style.height = '80px';
            stoneContainer.style.zIndex = '15';
            stoneContainer.style.cursor = 'pointer';
            
            // 创建石头 - 初始状态
            const stone = document.createElement('div');
            stone.id = 'stone';
            stone.textContent = '🪨';
            stone.style.width = '80px';
            stone.style.height = '80px';
            stone.style.fontSize = '80px';
            stone.style.lineHeight = '80px';
            stone.style.textAlign = 'center';
            stone.style.filter = 'drop-shadow(0 8px 15px rgba(0,0,0,0.8))';
            
            // 石头点击事件
            stoneContainer.onclick = (e) => {
                e.stopPropagation();
                if (stonePushPosition < 5) {
                    executeCommand('push stone');
                } else {
                    // 第5次推动后，禁用点击事件和pointer events
                    stoneContainer.onclick = null;
                    stoneContainer.style.cursor = 'default';
                    stoneContainer.style.pointerEvents = 'none';
                }
            };
            
            // 监听推动次数变化，第5次后隐藏提示
            const checkHintVisibility = () => {
                if (stonePushPosition >= 5) {
                    const hint = document.querySelector('#stoneSlope div[style*="点击石头推动它"]');
                    if (hint) {
                        hint.style.display = 'none';
                    }
                    // 同时禁用石头点击事件和pointer events
                    const stoneContainer = document.getElementById('stoneContainer');
                    if (stoneContainer) {
                        stoneContainer.style.cursor = 'default';
                        stoneContainer.style.pointerEvents = 'none'; // 禁用pointer events
                        stoneContainer.onclick = null;
                    }
                }
            };
            
            // 定期检查提示可见性
            setInterval(checkHintVisibility, 100);
            
            // 石头悬停效果
            stoneContainer.onmouseover = () => {
                if (stonePushPosition < 5) {
                    stone.style.transform = 'scale(1.1)';
                    stone.style.filter = 'drop-shadow(0 8px 20px rgba(0,0,0,1))';
                }
            };
            
            stoneContainer.onmouseout = () => {
                if (stonePushPosition < 5) {
                    stone.style.transform = 'scale(1)';
                    stone.style.filter = 'drop-shadow(0 8px 15px rgba(0,0,0,0.8))';
                }
            };
            
            // 创建提示文字
            const hint = document.createElement('div');
            hint.textContent = '💡 Click the stone to push it!';
            hint.style.position = 'absolute';
            hint.style.left = (centerX - 100) + 'px';
            hint.style.top = (centerY + 200) + 'px';
            hint.style.width = '200px';
            hint.style.height = '30px';
            hint.style.color = '#ffd700';
            hint.style.fontSize = '18px';
            hint.style.fontWeight = 'bold';
            hint.style.textAlign = 'center';
            hint.style.textShadow = '0 0 10px rgba(0,0,0,0.8)';
            hint.style.zIndex = '15';
            hint.style.pointerEvents = 'none';
            
            // 添加到容器
            stoneContainer.appendChild(stone);
            slopeContainer.appendChild(mountain);
            slopeContainer.appendChild(stoneContainer);
            slopeContainer.appendChild(hint);
            
            // 初始化石头位置 - 同步游戏状态
            stonePushPosition = game.gameState.stoneCirclePushCount || 0;
            updateStonePosition();
        }

        // Show Garden Choice Buttons - 全新的简洁设计
        function showGardenChoiceButtons() {
            console.log('🌹 重新设计花园选择界面');
            
            // 清理所有旧的元素
            const existingElements = document.querySelectorAll('.rose-choice-button, #gardenChoiceHint, .garden-rose-card');
            existingElements.forEach(element => element.remove());
            
            // 延迟执行，确保清理完成
            setTimeout(() => {
                // 创建选择提示
                const hint = document.createElement('div');
                hint.id = 'gardenChoiceHint';
                hint.style.position = 'absolute';
                hint.style.left = '50%';
                hint.style.top = '15%';
                hint.style.transform = 'translateX(-50%)';
                hint.style.color = '#ffd700';
                hint.style.fontSize = '24px';
                hint.style.fontWeight = 'bold';
                hint.style.textAlign = 'center';
                hint.style.textShadow = '0 0 15px rgba(255, 215, 0, 0.8)';
                hint.style.whiteSpace = 'nowrap';
                hint.style.zIndex = '25';
                hint.style.animation = 'hintPulse 2s ease-in-out infinite';
                hint.textContent = '💖 Choose your heart\'s rose';
                
                // 创建三个玫瑰选择卡片
                const roses = [
                    { id: 'red', emoji: '🌹', name: 'Red Rose', color: '#ff4757', textColor: '#ffffff' },
                    { id: 'white', emoji: '🤍', name: 'White Rose', color: '#f8f9fa', textColor: '#2f3542' },
                    { id: 'purple', emoji: '💜', name: 'Purple Rose', color: '#9c88ff', textColor: '#ffffff' }
                ];
                
                roses.forEach((rose, index) => {
                    // 创建玫瑰卡片容器
                    const card = document.createElement('div');
                    card.className = 'garden-rose-card';
                    card.style.position = 'absolute';
                    card.style.left = `${20 + index * 30}%`; // 20%, 50%, 80%
                    card.style.top = '45%';
                    card.style.transform = 'translate(-50%, -50%)';
                    card.style.width = '180px';
                    card.style.height = '220px';
                    card.style.background = `linear-gradient(135deg, ${rose.color}, ${adjustColor(rose.color, -20)})`;
                    card.style.border = '3px solid #ffd700';
                    card.style.borderRadius = '20px';
                    card.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.6)';
                    card.style.cursor = 'pointer';
                    card.style.transition = 'all 0.3s ease';
                    card.style.zIndex = '20';
                    card.style.display = 'flex';
                    card.style.flexDirection = 'column';
                    card.style.alignItems = 'center';
                    card.style.justifyContent = 'center';
                    card.style.animation = 'cardFloat 3s ease-in-out infinite';
                    card.style.animationDelay = `${index * 0.2}s`;
                    
                    // 创建玫瑰图标
                    const roseIcon = document.createElement('div');
                    roseIcon.style.fontSize = '80px';
                    roseIcon.style.marginBottom = '15px';
                    roseIcon.style.filter = 'drop-shadow(0 0 10px rgba(0,0,0,0.3))';
                    roseIcon.textContent = rose.emoji;
                    
                    // 创建玫瑰名称
                    const roseName = document.createElement('div');
                    roseName.style.color = rose.textColor;
                    roseName.style.fontSize = '18px';
                    roseName.style.fontWeight = 'bold';
                    roseName.style.textAlign = 'center';
                    roseName.style.textShadow = '0 0 5px rgba(0,0,0,0.5)';
                    roseName.style.marginBottom = '10px';
                    roseName.textContent = rose.name;
                    
                    // 创建对话按钮
                    const talkButton = document.createElement('div');
                    talkButton.style.background = 'rgba(78, 205, 196, 0.9)';
                    talkButton.style.color = '#ffffff';
                    talkButton.style.padding = '8px 16px';
                    talkButton.style.borderRadius = '15px';
                    talkButton.style.fontSize = '14px';
                    talkButton.style.fontWeight = 'bold';
                    talkButton.style.textAlign = 'center';
                    talkButton.style.boxShadow = '0 0 15px rgba(78, 205, 196, 0.5)';
                    talkButton.style.transition = 'all 0.3s ease';
                    talkButton.style.marginBottom = '8px';
                    talkButton.textContent = 'Talk';
                    
                    // 创建选择按钮（初始隐藏）
                    const selectButton = document.createElement('div');
                    selectButton.style.background = 'rgba(255, 215, 0, 0.9)';
                    selectButton.style.color = '#2f3542';
                    selectButton.style.padding = '8px 16px';
                    selectButton.style.borderRadius = '15px';
                    selectButton.style.fontSize = '14px';
                    selectButton.style.fontWeight = 'bold';
                    selectButton.style.textAlign = 'center';
                    selectButton.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.5)';
                    selectButton.style.transition = 'all 0.3s ease';
                    selectButton.style.display = 'none'; // 初始隐藏
                    selectButton.textContent = 'Select';
                    selectButton.id = `select-${rose.id}`;
                    selectButton.onclick = (e) => {
                        e.stopPropagation();
                        executeCommand(`choose ${rose.id}`);
                    };
                    
                    // 为对话按钮添加点击事件和完成后的回调
                    talkButton.onclick = (e) => {
                        e.stopPropagation();
                        executeCommand(`talk ${rose.id}`);
                        
                        // 对话完成后检查是否所有玫瑰都已对话过
                        setTimeout(() => {
                            checkAndShowSelectButtons();
                        }, 2000); // 延迟2秒，确保对话完成
                    };
                    
                    // 组装卡片
                    card.appendChild(roseIcon);
                    card.appendChild(roseName);
                    card.appendChild(talkButton);
                    card.appendChild(selectButton);
                    
                    // 悬停效果
                    card.onmouseover = () => {
                        card.style.transform = 'translate(-50%, -50%) scale(1.05)';
                        card.style.boxShadow = '0 0 40px rgba(255, 215, 0, 0.8)';
                        card.style.animation = 'none';
                    };
                    
                    card.onmouseout = () => {
                        card.style.transform = 'translate(-50%, -50%) scale(1)';
                        card.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.6)';
                        card.style.animation = 'cardFloat 3s ease-in-out infinite';
                    };
                    
                    // 点击事件 - 点击卡片不再直接选择，而是对话
                    card.onclick = () => {
                        executeCommand(`talk ${rose.id}`);
                    };
                    
                    // 添加到页面
                    document.getElementById('objectsLayer').appendChild(card);
                });
                
                // 检查并显示选择按钮的函数
                function checkAndShowSelectButtons() {
                    // 检查是否所有玫瑰都已对话过
                    if (game.gameState.gardenRosesTalked && game.gameState.gardenRosesTalked.size === 3) {
                        console.log('🌹 所有玫瑰都已对话，显示选择按钮');
                        // 显示所有选择按钮
                        roses.forEach(rose => {
                            const selectBtn = document.getElementById(`select-${rose.id}`);
                            if (selectBtn) {
                                selectBtn.style.display = 'block';
                                selectBtn.style.animation = 'buttonGlow 1s ease-in-out';
                            }
                        });
                    }
                }
                
                // 初始检查（如果已经对话过）
                checkAndShowSelectButtons();
                
                // 添加卡片浮动动画
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes cardFloat {
                        0%, 100% { transform: translate(-50%, -50%) translateY(0px); }
                        50% { transform: translate(-50%, -50%) translateY(-10px); }
                    }
                    @keyframes hintPulse {
                        0%, 100% { opacity: 0.8; transform: translateX(-50%) scale(1); }
                        50% { opacity: 1; transform: translateX(-50%) scale(1.05); }
                    }
                    @keyframes buttonGlow {
                        0% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
                        50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
                        100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
                    }
                `;
                document.head.appendChild(style);
                
                // 添加提示到页面
                document.getElementById('objectsLayer').appendChild(hint);
            }, 100);
        }

        // Show Garden Planting Process
        function showGardenPlanting() {
            const step = game.gameState.gardenPlantingStep || 0;
            const chosenRose = game.gameState.gardenRoseChosen;
            
            // 清理所有旧的元素
            const existingElements = document.querySelectorAll('.garden-rose-card, #gardenChoiceHint, #gardenPlanting, #chosenRose');
            existingElements.forEach(element => element.remove());
            
            // 创建种植区域
            const plantingArea = document.createElement('div');
            plantingArea.id = 'gardenPlanting';
            plantingArea.style.position = 'absolute';
            plantingArea.style.left = '50%';
            plantingArea.style.top = '50%';
            plantingArea.style.transform = 'translate(-50%, -50%)';
            plantingArea.style.width = '400px';
            plantingArea.style.height = '500px';
            plantingArea.style.zIndex = '10';
            plantingArea.style.display = 'flex';
            plantingArea.style.flexDirection = 'column';
            plantingArea.style.alignItems = 'center';
            plantingArea.style.justifyContent = 'center';
            
            // 创建被选中的玫瑰（缩小版）
            const chosenRoseElement = document.createElement('div');
            chosenRoseElement.id = 'chosenRose';
            chosenRoseElement.style.position = 'absolute';
            chosenRoseElement.style.left = '50%';
            chosenRoseElement.style.top = '35%'; // 向上移动，远离按钮
            chosenRoseElement.style.transform = 'translate(-50%, -50%)';
            chosenRoseElement.style.zIndex = '15';
            
            // 根据选择的玫瑰设置颜色和图标
            const roseConfig = {
                red: { emoji: '🌹', color: '#ff4757', name: 'Red Rose' },
                white: { emoji: '🤍', color: '#f8f9fa', name: 'White Rose' },
                purple: { emoji: '💜', color: '#9c88ff', name: 'Purple Rose' }
            };
            
            const config = roseConfig[chosenRose];
            if (config) {
                // 根据步骤设置玫瑰大小
                const baseSize = 60;
                const growthFactor = 1 + (step * 0.3); // 每步增长30%
                const currentSize = Math.min(baseSize * growthFactor, 200); // 最大200px
                
                chosenRoseElement.innerHTML = `
                    <div style="
                        font-size: ${currentSize}px;
                        text-align: center;
                        filter: drop-shadow(0 0 20px ${config.color}80);
                        animation: roseGlow 2s ease-in-out infinite;
                        transition: all 0.5s ease;
                    ">${config.emoji}</div>
                    <div style="
                        color: ${config.color};
                        font-size: 16px;
                        font-weight: bold;
                        text-align: center;
                        margin-top: 10px;
                        text-shadow: 0 0 10px ${config.color}80;
                    ">${config.name}</div>
                `;
                
                // 添加玫瑰发光动画
                if (!document.getElementById('roseGlowStyle')) {
                    const style = document.createElement('style');
                    style.id = 'roseGlowStyle';
                    style.textContent = `
                        @keyframes roseGlow {
                            0%, 100% { 
                                filter: drop-shadow(0 0 20px ${config.color}80) brightness(1);
                                transform: scale(1);
                            }
                            50% { 
                                filter: drop-shadow(0 0 30px ${config.color}CC) brightness(1.2);
                                transform: scale(1.05);
                            }
                        }
                        @keyframes roseGrow {
                            0% { transform: scale(0.5); opacity: 0; }
                            50% { transform: scale(1.1); opacity: 0.8; }
                            100% { transform: scale(1); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // 添加生长动画
                chosenRoseElement.style.animation = 'roseGrow 0.8s ease-out';
            }
            
            plantingArea.appendChild(chosenRoseElement);
            
            // 显示当前步骤的按钮
            if (step < 5) {
                const actionButtons = ['water', 'fertilize', 'weed', 'wish', 'wait'];
                const currentAction = actionButtons[step];
                const actionNames = {
                    water: '💧 Water',
                    fertilize: '🌱 Fertilize', 
                    weed: '🌿 Weed',
                    wish: '✨ Wish',
                    wait: '⏰ Wait'
                };
                
                const button = document.createElement('div');
                button.className = 'garden-action-button';
                button.style.position = 'absolute';
                button.style.left = '50%';
                button.style.top = '85%'; // 向下移动，远离花朵
                button.style.transform = 'translate(-50%, -50%)';
                button.style.width = '140px';
                button.style.height = '50px';
                button.style.background = `linear-gradient(135deg, ${config.color}, ${adjustColor(config.color, -30)})`;
                button.style.color = chosenRose === 'white' ? '#2f3542' : '#ffffff';
                button.style.border = '2px solid #ffd700';
                button.style.borderRadius = '25px';
                button.style.fontSize = '16px';
                button.style.fontWeight = 'bold';
                button.style.cursor = 'pointer';
                button.style.boxShadow = `0 0 25px ${config.color}80, 0 0 15px rgba(255, 215, 0, 0.6)`;
                button.style.transition = 'all 0.3s ease';
                button.style.textAlign = 'center';
                button.style.display = 'flex';
                button.style.alignItems = 'center';
                button.style.justifyContent = 'center';
                button.textContent = actionNames[currentAction];
                
                button.onclick = () => {
                    executeCommand(currentAction);
                };
                
                button.onmouseover = () => {
                    button.style.transform = 'translate(-50%, -50%) scale(1.1)';
                    button.style.boxShadow = `0 0 35px ${config.color}CC, 0 0 25px rgba(255, 215, 0, 0.8)`;
                };
                
                button.onmouseout = () => {
                    button.style.transform = 'translate(-50%, -50%) scale(1)';
                    button.style.boxShadow = `0 0 25px ${config.color}80, 0 0 15px rgba(255, 215, 0, 0.6)`;
                };
                
                plantingArea.appendChild(button);
            } else {
                // 第5步完成，隐藏花朵，显示种子掉落
                chosenRoseElement.style.display = 'none';
                
                // 延迟显示种子掉落效果
                setTimeout(() => {
                showSeedDrop();
                }, 500);
            }
            
            // 添加步骤指示器
            const stepIndicator = document.createElement('div');
            stepIndicator.style.position = 'absolute';
            stepIndicator.style.left = '50%';
            stepIndicator.style.top = '10%';
            stepIndicator.style.transform = 'translateX(-50%)';
            stepIndicator.style.color = '#ffd700';
            stepIndicator.style.fontSize = '14px';
            stepIndicator.style.fontWeight = 'bold';
            stepIndicator.style.textAlign = 'center';
            stepIndicator.style.textShadow = '0 0 10px rgba(255, 215, 0, 0.8)';
            stepIndicator.textContent = `Step ${step + 1}/5`;
            
            plantingArea.appendChild(stepIndicator);
            
            document.getElementById('objectsLayer').appendChild(plantingArea);
        }
        
        // Show Guide Final Dialogue - 多轮对话系统
        function showGuideFinalDialogue(message, isSecondDialogue = false) {
            console.log('🎭 showGuideFinalDialogue called:', { message, isSecondDialogue });
            // 检查是否已经存在对话框
            const existingDialog = document.getElementById('guideFinalDialog');
            if (existingDialog) {
                console.log('🎭 Removing existing dialog');
                existingDialog.remove();
            }
            
            // 将对话内容添加到历史记录
            if (message) {
                addToHistory(message, 'success-message');
            } else if (isSecondDialogue) {
                // 第二次对话：添加inventory内容到历史记录
                const inventoryMessage = `📦 Inventory:
- 🔥 Flame of Courage: A flame that burns away illusions and lights the path of truth.
- 🪶 Feather of Freedom: A feather that symbolizes the courage to break free and soar.
- 🛡️ Shield of Wisdom: A shield forged from understanding, experience, communication, and reflection.
- 🔮 Orb of Creation: A crystal orb that holds the power of imagination and vision.
- 🪨 Stone Fragment of Grit: A stone that embodies perseverance and inner strength.
- 🌱 Seed of Love: A shining seed that contains the essence of love and responsibility.

Guide: I believe you've gathered everything needed to restore the Hexagram! Try placing them onto the disk one by one and see what happens.
(Type 'repair disk' to place your six tokens into the Hexagram.)`;
                addToHistory(inventoryMessage, 'success-message');
            } else {
                // 第一次对话：添加欢迎信息到历史记录
                const welcomeMessage = `Guide: Welcome back, young one. Let me see what you've brought with you.
(Type 'inventory' to check the items in your inventory)`;
                addToHistory(welcomeMessage, 'success-message');
            }
            
            // 创建对话框
            const dialog = document.createElement('div');
            dialog.id = 'guideFinalDialog';
            dialog.style.position = 'fixed';
            dialog.style.left = '50%';
            dialog.style.top = '50%';
            dialog.style.transform = 'translate(-50%, -50%)';
            dialog.style.width = '700px';
            dialog.style.maxWidth = '90vw';
            dialog.style.height = '500px';
            dialog.style.maxHeight = '80vh';
            dialog.style.background = 'linear-gradient(135deg, #1a1a2e, #16213e)';
            dialog.style.border = '3px solid #ffd700';
            dialog.style.borderRadius = '20px';
            dialog.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.5)';
            dialog.style.zIndex = '1000';
            dialog.style.display = 'flex';
            dialog.style.flexDirection = 'column';
            dialog.style.overflow = 'hidden';
            
            // 标题栏
            const header = document.createElement('div');
            header.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
            header.style.color = '#1a1a2e';
            header.style.padding = '15px';
            header.style.fontSize = '20px';
            header.style.fontWeight = 'bold';
            header.style.textAlign = 'center';
            header.style.borderBottom = '2px solid #ffd700';
            header.textContent = 'Final Guide';
            dialog.appendChild(header);
            
            // 内容区域
            const content = document.createElement('div');
            content.id = 'guideFinalContent';
            content.style.flex = '1';
            content.style.padding = '20px';
            content.style.color = '#ffffff';
            content.style.fontSize = '16px';
            content.style.lineHeight = '1.6';
            content.style.overflowY = 'auto';
            
            if (isSecondDialogue) {
                // 第二次对话：显示背包内容和修复提示
                const inventoryMessage = `📦 Inventory:
- 🔥 Flame of Courage: A flame that burns away illusions and lights the path of truth.
- 🪶 Feather of Freedom: A feather that symbolizes the courage to break free and soar.
- 🛡️ Shield of Wisdom: A shield forged from understanding, experience, communication, and reflection.
- 🔮 Orb of Creation: A crystal orb that holds the power of imagination and vision.
- 🪨 Stone Fragment of Grit: A stone that embodies perseverance and inner strength.
- 🌱 Seed of Love: A shining seed that contains the essence of love and responsibility.

Guide: I believe you've gathered everything needed to restore the Hexagram! Try placing them onto the disk one by one and see what happens.
(Type 'repair disk' to place your six tokens into the Hexagram.)`;
                
                // 将第二次对话内容添加到历史记录
                addToHistory(inventoryMessage, 'success-message');
                
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #ffd700; margin-bottom: 15px;">📦 Inventory:</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 8px;">🔥 Flame of Courage: A flame that burns away illusions and lights the path of truth.</li>
                            <li style="margin-bottom: 8px;">🪶 Feather of Freedom: A feather that symbolizes the courage to break free and soar.</li>
                            <li style="margin-bottom: 8px;">🛡️ Shield of Wisdom: A shield forged from understanding, experience, communication, and reflection.</li>
                            <li style="margin-bottom: 8px;">🔮 Orb of Creation: A crystal orb that holds the power of imagination and vision.</li>
                            <li style="margin-bottom: 8px;">🪨 Stone Fragment of Grit: A stone that embodies perseverance and inner strength.</li>
                            <li style="margin-bottom: 8px;">🌱 Seed of Love: A shining seed that contains the essence of love and responsibility.</li>
                        </ul>
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ffd700;">
                        <p style="color: #ffd700; font-weight: bold;">Guide: I believe you've gathered everything needed to restore the Hexagram! Try placing them onto the disk one by one and see what happens.</p>
                        <p style="margin-top: 10px; font-style: italic;">(Type 'repair disk' to place your six tokens into the Hexagram.)</p>
                    </div>
                `;
            } else {
                // 第一次对话：欢迎信息
                content.innerHTML = `
                    <p style="color: #ffd700; font-weight: bold; margin-bottom: 20px;">Guide: Welcome back, young one. Let me see what you've brought with you.</p>
                    <p style="font-style: italic;">(Type 'inventory' to check the items in your inventory)</p>
                `;
            }
            
            dialog.appendChild(content);
            
            // 按钮区域
            const buttonArea = document.createElement('div');
            buttonArea.style.padding = '15px';
            buttonArea.style.borderTop = '2px solid #ffd700';
            buttonArea.style.display = 'flex';
            buttonArea.style.gap = '10px';
            buttonArea.style.justifyContent = 'center';
            
            if (!isSecondDialogue) {
                // 第一次对话 - 显示Inventory按钮
                const inventoryBtn = document.createElement('button');
                inventoryBtn.textContent = '📦 Inventory';
                inventoryBtn.style.padding = '10px 20px';
                inventoryBtn.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
                inventoryBtn.style.color = 'white';
                inventoryBtn.style.border = 'none';
                inventoryBtn.style.borderRadius = '10px';
                inventoryBtn.style.cursor = 'pointer';
                inventoryBtn.style.fontSize = '14px';
                inventoryBtn.style.fontWeight = 'bold';
                inventoryBtn.style.transition = 'all 0.3s ease';
                inventoryBtn.onclick = () => {
                    // 执行inventory命令
                    executeCommand('inventory');
                    // 设置标志，表示已经看过inventory
                    game.gameState.courtyardFinalTalked = true;
                    // 关闭当前对话框
                    dialog.remove();
                    // 立即显示第二次对话
                    setTimeout(() => {
                        console.log('🎭 Showing second dialogue after inventory');
                        showGuideFinalDialogue('', true);
                    }, 300);
                };
                inventoryBtn.onmouseover = () => {
                    inventoryBtn.style.transform = 'scale(1.05)';
                    inventoryBtn.style.boxShadow = '0 0 15px rgba(78, 205, 196, 0.6)';
                };
                inventoryBtn.onmouseout = () => {
                    inventoryBtn.style.transform = 'scale(1)';
                    inventoryBtn.style.boxShadow = 'none';
                };
                buttonArea.appendChild(inventoryBtn);
            } else {
                // 第二次对话 - 只显示结束按钮
                const endBtn = document.createElement('button');
                endBtn.textContent = 'End';
                endBtn.style.padding = '10px 20px';
                endBtn.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
                endBtn.style.color = 'white';
                endBtn.style.border = 'none';
                endBtn.style.borderRadius = '10px';
                endBtn.style.cursor = 'pointer';
                endBtn.style.fontSize = '14px';
                endBtn.style.fontWeight = 'bold';
                endBtn.style.transition = 'all 0.3s ease';
                endBtn.onclick = () => {
                    // 关闭对话框
                    dialog.remove();
                    // 设置对话状态为结束
                    game.gameState.inConversation = false;
                    game.gameState.currentDialogueNpc = null;
                    game.gameState.currentDialogueIndex = 0;
                    game.gameState.conversationState = '';
                    
                    // 更新六芒星圆圈，使其可点击
                    updateHexagramCirclesForRepair();
                };
                endBtn.onmouseover = () => {
                    endBtn.style.transform = 'scale(1.05)';
                    endBtn.style.boxShadow = '0 0 15px rgba(255, 107, 107, 0.6)';
                };
                endBtn.onmouseout = () => {
                    endBtn.style.transform = 'scale(1)';
                    endBtn.style.boxShadow = 'none';
                };
                buttonArea.appendChild(endBtn);
            }
            
            dialog.appendChild(buttonArea);
            document.body.appendChild(dialog);
        }
        
        // Update Hexagram Circles for Repair - 对话框结束后添加交互
        function updateHexagramCirclesForRepair() {
            // 对话框结束后，让圆圈可以点击
            setTimeout(() => {
                const circles = document.querySelectorAll('.disk-slot');
                circles.forEach(circle => {
                    // 添加点击事件
                    circle.onclick = () => {
                        executeCommand('repair disk');
                    };
                    
                    // 添加提示效果
                    circle.style.cursor = 'pointer';
                    circle.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.5)';
                    circle.style.animation = 'circlePulse 2s ease-in-out infinite';
                    
                    // 添加悬停提示
                    circle.title = 'repair disk';
                    circle.setAttribute('data-tooltip', 'repair disk');
                });
                
                // 添加脉冲动画样式
                if (!document.getElementById('circlePulseStyle')) {
                    const style = document.createElement('style');
                    style.id = 'circlePulseStyle';
                    style.textContent = `
                        @keyframes circlePulse {
                            0%, 100% { 
                                transform: scale(1);
                                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
                            }
                            50% { 
                                transform: scale(1.05);
                                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // 添加自定义提示框样式
                if (!document.getElementById('repairTooltipStyle')) {
                    const tooltipStyle = document.createElement('style');
                    tooltipStyle.id = 'repairTooltipStyle';
                    tooltipStyle.textContent = `
                        .disk-slot[data-tooltip]:hover::after {
                            content: attr(data-tooltip);
                            position: absolute;
                            bottom: 100%;
                            left: 50%;
                            transform: translateX(-50%);
                            background: rgba(0, 0, 0, 0.9);
                            color: #ffd700;
                            padding: 8px 12px;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: bold;
                            white-space: nowrap;
                            z-index: 1000;
                            pointer-events: none;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                            border: 1px solid #ffd700;
                            animation: tooltipFadeIn 0.3s ease-out;
                        }
                        
                        .disk-slot[data-tooltip]:hover::before {
                            content: '';
                            position: absolute;
                            bottom: 100%;
                            left: 50%;
                            transform: translateX(-50%);
                            border: 5px solid transparent;
                            border-top-color: #ffd700;
                            z-index: 1000;
                            pointer-events: none;
                            animation: tooltipFadeIn 0.3s ease-out;
                        }
                        
                        @keyframes tooltipFadeIn {
                            0% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
                            100% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        }
                        
                    `;
                    document.head.appendChild(tooltipStyle);
                }
            }, 100);
        }
        
        // Show Repair Disk Button
        function showRepairDiskButton() {
            const repairBtn = document.createElement('div');
            repairBtn.id = 'repairDiskButton';
            repairBtn.style.position = 'absolute';
            repairBtn.style.left = '50%';
            repairBtn.style.top = '70%';
            repairBtn.style.transform = 'translate(-50%, -50%)';
            repairBtn.style.width = '200px';
            repairBtn.style.height = '60px';
            repairBtn.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
            repairBtn.style.border = '3px solid #ff6b6b';
            repairBtn.style.borderRadius = '15px';
            repairBtn.style.display = 'flex';
            repairBtn.style.alignItems = 'center';
            repairBtn.style.justifyContent = 'center';
            repairBtn.style.cursor = 'pointer';
            repairBtn.style.fontSize = '18px';
            repairBtn.style.fontWeight = 'bold';
            repairBtn.style.color = '#1a1a2e';
            repairBtn.style.boxShadow = '0 0 25px rgba(255, 107, 107, 0.5)';
            repairBtn.style.transition = 'all 0.3s ease';
            repairBtn.style.zIndex = '20';
            repairBtn.style.animation = 'repairButtonPulse 2s ease-in-out infinite';
            repairBtn.textContent = '🔧 Repair Disk';
            
            repairBtn.onclick = () => {
                executeCommand('repair disk');
            };
            
            repairBtn.onmouseover = () => {
                repairBtn.style.transform = 'translate(-50%, -50%) scale(1.1)';
                repairBtn.style.boxShadow = '0 0 35px rgba(255, 107, 107, 0.8)';
                repairBtn.style.animation = 'none';
            };
            
            repairBtn.onmouseout = () => {
                repairBtn.style.transform = 'translate(-50%, -50%) scale(1)';
                repairBtn.style.boxShadow = '0 0 25px rgba(255, 107, 107, 0.5)';
                repairBtn.style.animation = 'repairButtonPulse 2s ease-in-out infinite';
            };
            
            // 添加脉冲动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes repairButtonPulse {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 25px rgba(255, 107, 107, 0.5); }
                    50% { transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 0 30px rgba(255, 107, 107, 0.7); }
                }
            `;
            document.head.appendChild(style);
            
            document.getElementById('objectsLayer').appendChild(repairBtn);
        }

        // Show Hexagram Repair Animation - 炫酷的修复特效
        function showHexagramRepair() {
            console.log('showHexagramRepair called');
            console.log('Current inventory:', game.gameState.inventory);
            
            // 使用与收集进度相同的物品数据，确保完全同步
            const symbolsList = [
                { id: 'flame_of_courage', emoji: '🔥', title: 'Flame of Courage' },
                { id: 'feather_of_freedom', emoji: '🪶', title: 'Feather of Freedom' },
                { id: 'shield_of_wisdom', emoji: '🛡️', title: 'Shield of Wisdom' },
                { id: 'orb_of_creation', emoji: '🔮', title: 'Orb of Creation' },
                { id: 'stone_of_grit', emoji: '🪨', title: 'Stone of Grit' },
                { id: 'seed_of_love', emoji: '🌱', title: 'Seed of Love' }
            ];
            
            const circles = document.querySelectorAll('.disk-slot');
            console.log('Found circles:', circles.length);
            
            // 如果没有找到圆圈，尝试重新创建
            if (circles.length === 0) {
                console.log('No circles found, recreating...');
                showHexagramCircles();
                // 等待一下再重新查找
                setTimeout(() => {
                    const newCircles = document.querySelectorAll('.disk-slot');
                    console.log('New circles found:', newCircles.length);
                    if (newCircles.length > 0) {
                        fillCirclesWithItems(newCircles, symbolsList);
                    }
                }, 100);
                return;
            }
            
            fillCirclesWithItems(circles, symbolsList);
        }
        
        // 填充圆圈的函数
        function fillCirclesWithItems(circles, symbolsList) {
            console.log('fillCirclesWithItems called with', circles.length, 'circles');
            
            // 如果圆圈为空，尝试重新查找
            if (circles.length === 0) {
                console.log('No circles found, trying to find them again...');
                circles = document.querySelectorAll('.disk-slot');
                console.log('Found', circles.length, 'circles on retry');
            }
            
            // 添加飞入动画样式
            if (!document.getElementById('itemFlyInStyle')) {
                    const style = document.createElement('style');
                style.id = 'itemFlyInStyle';
                    style.textContent = `
                        @keyframes itemFlyIn {
                        0% { 
                            transform: translate(-50%, -50%) scale(0) rotate(-180deg); 
                            opacity: 0; 
                            filter: brightness(0);
                        }
                        30% { 
                            transform: translate(-50%, -50%) scale(1.3) rotate(-90deg); 
                            opacity: 0.8; 
                            filter: brightness(1.5);
                        }
                        60% { 
                            transform: translate(-50%, -50%) scale(0.9) rotate(0deg); 
                            opacity: 1; 
                            filter: brightness(1.2);
                        }
                        100% { 
                            transform: translate(-50%, -50%) scale(1) rotate(0deg); 
                            opacity: 1; 
                            filter: brightness(1);
                        }
                    }
                    @keyframes circleGlow {
                        0%, 100% { 
                            box-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
                            background: rgba(255, 215, 0, 0.3);
                        }
                        50% { 
                            box-shadow: 0 0 40px rgba(255, 215, 0, 0.9);
                            background: rgba(255, 215, 0, 0.5);
                        }
                        }
                    `;
                    document.head.appendChild(style);
            }
            
            // 计算需要填充的物品数量
            const itemsToFill = symbolsList.filter(symbol => game.gameState.inventory.includes(symbol.id));
            console.log(`Items to fill: ${itemsToFill.length} out of ${symbolsList.length}`);
            
            let filledCount = 0;
            
            // 根据背包中的物品来填充圆圈，与收集进度完全同步
            symbolsList.forEach((symbol, index) => {
                if (circles[index]) {
                    // 检查背包中是否有这个物品
                    const hasItem = game.gameState.inventory.includes(symbol.id);
                    console.log(`Symbol ${symbol.id}: hasItem = ${hasItem}`);
                    
                    // 立即填充物品，然后添加动画效果
                    if (hasItem) {
                        // 如果背包中有这个物品，立即显示它
                        const itemElement = document.createElement('div');
                        itemElement.style.position = 'absolute';
                        itemElement.style.left = '50%';
                        itemElement.style.top = '50%';
                        itemElement.style.transform = 'translate(-50%, -50%)';
                        itemElement.style.fontSize = '40px';
                        itemElement.style.filter = 'drop-shadow(0 0 10px rgba(255, 215, 0, 0.8))';
                        itemElement.style.display = 'flex';
                        itemElement.style.alignItems = 'center';
                        itemElement.style.justifyContent = 'center';
                        itemElement.style.width = '100%';
                        itemElement.style.height = '100%';
                        itemElement.textContent = symbol.emoji;
                        
                        // 立即添加到圆圈中
                    circles[index].appendChild(itemElement);
                    
                        // 立即更新圆圈样式（与收集进度的obtained样式一致）
                        circles[index].style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                        circles[index].style.boxShadow = '0 0 25px rgba(255, 215, 0, 0.8)';
                        circles[index].style.border = '3px solid #fff';
                    circles[index].style.cursor = 'default';
                    circles[index].onclick = null;
                        circles[index].style.animation = 'circleGlow 2s ease-in-out infinite';
                        
                        // 添加飞入动画
                        itemElement.style.animation = 'itemFlyIn 1.5s ease-out forwards';
                        itemElement.style.animationDelay = `${index * 0.3}s`;
                        
                        // 延迟添加粒子特效
                        setTimeout(() => {
                            createParticles('light', 15);
                            filledCount++;
                            console.log(`Filled ${filledCount}/${itemsToFill.length} items`);
                            
                            // 当所有物品都填充完成时，显示最终寄语
                            if (filledCount === itemsToFill.length) {
                                setTimeout(() => {
                                    console.log('All items filled, showing final message');
                                    showFinalGuideMessage();
                                }, 1000);
                            }
                        }, index * 300);
                    } else {
                        // 如果背包中没有这个物品，显示问号（与收集进度一致）
                        circles[index].style.background = 'rgba(0, 0, 0, 0.8)';
                        circles[index].style.border = '2px solid rgba(255, 215, 0, 0.4)';
                        circles[index].style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.3)';
                        circles[index].style.cursor = 'default';
                        circles[index].onclick = null;
                        circles[index].innerHTML = '<div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 14px; color: rgba(255, 215, 0, 0.3); display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">?</div>';
                    }
                }
            });
            
            // 如果没有物品需要填充，直接显示最终寄语
            if (itemsToFill.length === 0) {
            setTimeout(() => {
                    console.log('No items to fill, showing final message');
                showFinalGuideMessage();
                }, 1000);
            }
            
        }
        
        // Create Celebration Effects for Final Guide
        function createCelebrationEffects() {
            // 创建全屏庆祝背景
            const celebrationOverlay = document.createElement('div');
            celebrationOverlay.id = 'celebrationOverlay';
            celebrationOverlay.style.position = 'fixed';
            celebrationOverlay.style.top = '0';
            celebrationOverlay.style.left = '0';
            celebrationOverlay.style.width = '100%';
            celebrationOverlay.style.height = '100%';
            celebrationOverlay.style.background = 'radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, rgba(255, 107, 107, 0.05) 50%, rgba(0, 0, 0, 0.8) 100%)';
            celebrationOverlay.style.zIndex = '999';
            celebrationOverlay.style.pointerEvents = 'none';
            celebrationOverlay.style.animation = 'celebrationGlow 3s ease-in-out infinite';
            
            // 添加庆祝动画样式
            if (!document.getElementById('celebrationStyle')) {
                const style = document.createElement('style');
                style.id = 'celebrationStyle';
                style.textContent = `
                    @keyframes celebrationGlow {
                        0%, 100% { 
                            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, rgba(255, 107, 107, 0.05) 50%, rgba(0, 0, 0, 0.8) 100%);
                        }
                        50% { 
                            background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, rgba(255, 107, 107, 0.1) 50%, rgba(0, 0, 0, 0.7) 100%);
                        }
                    }
                    
                    @keyframes celebrationDialog {
                        0% { 
                            transform: translate(-50%, -50%) scale(0.5) rotate(-10deg);
                            opacity: 0;
                        }
                        50% { 
                            transform: translate(-50%, -50%) scale(1.05) rotate(2deg);
                            opacity: 1;
                        }
                        100% { 
                            transform: translate(-50%, -50%) scale(1) rotate(0deg);
                            opacity: 1;
                        }
                    }
                    
                    @keyframes celebrationPulse {
                        0%, 100% { 
                            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
                        }
                        50% { 
                            box-shadow: 0 0 80px rgba(255, 215, 0, 1), 0 0 120px rgba(255, 107, 107, 0.5);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(celebrationOverlay);
            
            // 创建大量粒子特效
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    createParticles('light', 20);
                    createParticles('magic', 15);
                    createParticles('star', 10);
                }, i * 50);
            }
            
            // 创建彩色烟花效果
            setTimeout(() => {
                createFireworks();
            }, 500);
            
            // 创建闪烁星星
            setTimeout(() => {
                createTwinklingStars();
            }, 1000);
            
            // 5秒后移除庆祝背景
            setTimeout(() => {
                if (celebrationOverlay.parentNode) {
                    celebrationOverlay.remove();
                }
            }, 5000);
        }
        
        // Create Fireworks Effect
        function createFireworks() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#ffd700'];
            
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.style.position = 'fixed';
                    firework.style.left = Math.random() * window.innerWidth + 'px';
                    firework.style.top = Math.random() * window.innerHeight + 'px';
                    firework.style.width = '6px';
                    firework.style.height = '6px';
                    firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.borderRadius = '50%';
                    firework.style.zIndex = '1000';
                    firework.style.animation = 'fireworkExplode 2s ease-out forwards';
                    
                    document.body.appendChild(firework);
                    
                    setTimeout(() => {
                        if (firework.parentNode) {
                            firework.remove();
                        }
            }, 2000);
                }, i * 200);
            }
            
            // 添加烟花动画样式
            if (!document.getElementById('fireworkStyle')) {
                const style = document.createElement('style');
                style.id = 'fireworkStyle';
                style.textContent = `
                    @keyframes fireworkExplode {
                        0% { 
                            transform: scale(0);
                            opacity: 1;
                        }
                        50% { 
                            transform: scale(3);
                            opacity: 0.8;
                        }
                        100% { 
                            transform: scale(6);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Create Twinkling Stars
        function createTwinklingStars() {
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.style.position = 'fixed';
                star.style.left = Math.random() * window.innerWidth + 'px';
                star.style.top = Math.random() * window.innerHeight + 'px';
                star.style.width = '4px';
                star.style.height = '4px';
                star.style.background = '#ffd700';
                star.style.borderRadius = '50%';
                star.style.zIndex = '1000';
                star.style.animation = `twinkle ${1 + Math.random() * 2}s ease-in-out infinite`;
                star.style.animationDelay = Math.random() * 2 + 's';
                
                document.body.appendChild(star);
                
                setTimeout(() => {
                    if (star.parentNode) {
                        star.remove();
                    }
                }, 8000);
            }
            
            // 添加闪烁动画样式
            if (!document.getElementById('twinkleStyle')) {
                const style = document.createElement('style');
                style.id = 'twinkleStyle';
                style.textContent = `
                    @keyframes twinkle {
                        0%, 100% { 
                            opacity: 0.3;
                            transform: scale(0.5);
                        }
                        50% { 
                            opacity: 1;
                            transform: scale(1.2);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Show Final Guide Message
        function showFinalGuideMessage() {
            // 创建庆祝特效
            createCelebrationEffects();
            
            const message = `"Congratulations, traveler. You have walked through trials of <span style="color: #ff6b6b; font-weight: bold;">courage</span>, <span style="color: #4ecdc4; font-weight: bold;">freedom</span>, <span style="color: #45b7d1; font-weight: bold;">wisdom</span>, <span style="color: #96ceb4; font-weight: bold;">creation</span>, <span style="color: #feca57; font-weight: bold;">grit</span>, and <span style="color: #ff9ff3; font-weight: bold;">love</span>—<br><br>
and from each, you have gained more than symbols: <span style="color: #ffd700; font-weight: bold;">you have gained yourself</span>.<br><br>
<span style="color: #a8e6cf; font-style: italic;">Remember, these six powers are not the end, but companions for your road ahead.</span><br><br>
<span style="color: #ffb3ba; font-style: italic;">True completeness lies not in collecting, but in living them every day.</span><br><br>
<span style="color: #bae1ff; font-style: italic;">May the light you have kindled here guide your journey,<br>
and may every step beyond this courtyard bring you strength, wonder, and joy.</span>"`;
            
            const messageDialog = document.createElement('div');
            messageDialog.id = 'finalGuideMessage';
            messageDialog.style.position = 'fixed';
            messageDialog.style.left = '50%';
            messageDialog.style.top = '50%';
            messageDialog.style.transform = 'translate(-50%, -50%)';
            messageDialog.style.width = '900px';
            messageDialog.style.maxWidth = '95vw';
            messageDialog.style.height = '650px';
            messageDialog.style.maxHeight = '85vh';
            messageDialog.style.background = 'linear-gradient(135deg, #1a1a2e, #16213e)';
            messageDialog.style.border = '4px solid #ffd700';
            messageDialog.style.borderRadius = '25px';
            messageDialog.style.boxShadow = '0 0 40px rgba(255, 215, 0, 0.7)';
            messageDialog.style.zIndex = '1001';
            messageDialog.style.display = 'flex';
            messageDialog.style.flexDirection = 'column';
            messageDialog.style.overflow = 'hidden';
            messageDialog.style.animation = 'celebrationDialog 1.5s ease-out forwards';
            messageDialog.style.boxShadow = '0 0 50px rgba(255, 215, 0, 0.8)';
            messageDialog.style.animation = 'celebrationDialog 1.5s ease-out forwards, celebrationPulse 2s ease-in-out infinite 1.5s';
            
            // 添加出现动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes messageAppear {
                    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // 标题栏
            const header = document.createElement('div');
            header.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
            header.style.color = '#1a1a2e';
            header.style.padding = '20px';
            header.style.fontSize = '24px';
            header.style.fontWeight = 'bold';
            header.style.textAlign = 'center';
            header.style.borderBottom = '3px solid #ffd700';
            header.textContent = '🌟 Final Guide 🌟';
            messageDialog.appendChild(header);
            
            // 内容区域
            const content = document.createElement('div');
            content.style.flex = '1';
            content.style.padding = '30px';
            content.style.color = '#ffffff';
            content.style.fontSize = '18px';
            content.style.lineHeight = '1.8';
            content.style.overflowY = 'auto';
            content.style.textAlign = 'center';
            content.innerHTML = formatMessage(message);
            messageDialog.appendChild(content);
            
            // 按钮区域
            const buttonArea = document.createElement('div');
            buttonArea.style.display = 'flex';
            buttonArea.style.gap = '20px';
            buttonArea.style.justifyContent = 'center';
            buttonArea.style.margin = '20px 0';
            
            // 完成旅程按钮
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '✨ Complete Journey ✨';
            closeBtn.style.padding = '15px 30px';
            closeBtn.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
            closeBtn.style.color = '#1a1a2e';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '15px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.fontSize = '18px';
            closeBtn.style.fontWeight = 'bold';
            closeBtn.style.transition = 'all 0.3s ease';
            closeBtn.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.5)';
            closeBtn.onclick = () => {
                messageDialog.remove();
            };
            closeBtn.onmouseover = () => {
                closeBtn.style.transform = 'scale(1.05)';
                closeBtn.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.8)';
            };
            closeBtn.onmouseout = () => {
                closeBtn.style.transform = 'scale(1)';
                closeBtn.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.5)';
            };
            
            // 重置游戏按钮
            const resetBtn = document.createElement('button');
            resetBtn.textContent = '🔄 Restart';
            resetBtn.style.padding = '15px 30px';
            resetBtn.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
            resetBtn.style.color = 'white';
            resetBtn.style.border = 'none';
            resetBtn.style.borderRadius = '15px';
            resetBtn.style.cursor = 'pointer';
            resetBtn.style.fontSize = '18px';
            resetBtn.style.fontWeight = 'bold';
            resetBtn.style.transition = 'all 0.3s ease';
            resetBtn.style.boxShadow = '0 0 20px rgba(78, 205, 196, 0.5)';
            resetBtn.onclick = () => {
                messageDialog.remove();
                resetGame();
            };
            resetBtn.onmouseover = () => {
                resetBtn.style.transform = 'scale(1.05)';
                resetBtn.style.boxShadow = '0 0 30px rgba(78, 205, 196, 0.8)';
            };
            resetBtn.onmouseout = () => {
                resetBtn.style.transform = 'scale(1)';
                resetBtn.style.boxShadow = '0 0 20px rgba(78, 205, 196, 0.5)';
            };
            
            buttonArea.appendChild(closeBtn);
            buttonArea.appendChild(resetBtn);
            messageDialog.appendChild(buttonArea);
            document.body.appendChild(messageDialog);
            
            // 添加粒子效果
            createParticles('light', 50);
        }

        // Reset Game Function
        function resetGame() {
            // 清除所有游戏状态
            game.gameState = JSON.parse(JSON.stringify(game.defaultGameState));
            game.gameState.rosesTalked = new Set();
            game.gameState.caveNPCsTalked = new Set();
            game.gameState.theaterTalked = new Set();
            game.gameState.gardenRosesTalked = new Set();
            
            // 清除所有UI元素
            const elementsToRemove = [
                'guideFinalDialog',
                'finalGuideMessage',
                'hexagramCircles',
                'repairHint',
                'gardenPlanting',
                'chosenRose',
                'gardenChoiceHint'
            ];
            
            elementsToRemove.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.remove();
                }
            });
            
            // 清除所有卡片
            const cards = document.querySelectorAll('.garden-rose-card');
            cards.forEach(card => card.remove());
            
            // 清除所有掉落物品
            const dropElements = ['stoneDrop', 'seedDrop', 'orbDrop', 'shieldDrop'];
            dropElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.remove();
                }
            });
            
            // 重置到初始房间
            game.gameState.currentRoom = 'courtyard_start';
            
            // 更新显示
            updateInventory();
            updateSymbols();
            updateRoomDisplay();
            
            // 显示重置成功消息
            addToHistory('🎮 Game reset! Welcome to restart your journey!', 'success-message');
            createParticles('magic', 30);
        }

        // Show Hexagram Circles in Final Courtyard - 使用与第一个房间相同的disk-slot样式
        function showHexagramCircles() {
            // 检查是否已经有填充的圆圈，如果有就不重新创建
            const existingFilledCircles = document.querySelectorAll('.disk-slot');
            if (existingFilledCircles.length > 0) {
                console.log('Circles already exist and may be filled, skipping recreation');
                return;
            }
            
            // 清除可能存在的旧星盘
            const existingHexagram = document.getElementById('hexagramCircles');
            if (existingHexagram) {
                existingHexagram.remove();
            }
            
            // 创建与第一个房间相同的disk容器
            const hexagramContainer = document.createElement('div');
            hexagramContainer.id = 'hexagramCircles';
            hexagramContainer.style.position = 'absolute';
            hexagramContainer.style.left = '50%';
            hexagramContainer.style.top = '50%';
            hexagramContainer.style.transform = 'translate(-50%, -50%)';
            hexagramContainer.style.width = '250px';
            hexagramContainer.style.height = '250px';
            hexagramContainer.style.zIndex = '15';
            
            // 使用与第一个房间相同的符号列表和圆形布局
            const symbolsList = [
                { id: 'flame_of_courage', emoji: '🔥' },
                { id: 'feather_of_freedom', emoji: '🪶' },
                { id: 'shield_of_wisdom', emoji: '🛡️' },
                { id: 'orb_of_creation', emoji: '🔮' },
                { id: 'stone_of_grit', emoji: '🪨' },
                { id: 'seed_of_love', emoji: '🌱' }
            ];
            
            // 使用与第一个房间相同的圆形布局
            symbolsList.forEach((symbol, index) => {
                const angle = (index * 60 - 90) * Math.PI / 180; // Start from top
                const radius = 95;
                const x = 125 + radius * Math.cos(angle);
                const y = 125 + radius * Math.sin(angle);
                
                const slot = document.createElement('div');
                slot.className = 'disk-slot'; // 使用相同的CSS类
                slot.style.left = `${x - 30}px`;
                slot.style.top = `${y - 30}px`;
                slot.dataset.symbolId = symbol.id;
                slot.dataset.index = index;
                
                // 初始状态：完全空的圆圈
                slot.innerHTML = '';
                
                // 初始状态：不可点击，等待对话框结束
                slot.style.cursor = 'default';
                slot.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.3)';
                
                // 悬停效果
                slot.onmouseover = () => {
                    slot.style.transform = 'scale(1.1)';
                    slot.style.boxShadow = '0 0 25px rgba(255, 215, 0, 0.6)';
                };
                
                slot.onmouseout = () => {
                    slot.style.transform = 'scale(1)';
                    slot.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.3)';
                };
                
                hexagramContainer.appendChild(slot);
            });
            
            document.getElementById('objectsLayer').appendChild(hexagramContainer);
        }

        // Show Seed Drop Animation
        function showSeedDrop() {
            // 检查是否已经有种子掉落
            if (document.getElementById('seedDrop')) {
                return;
            }
            
            // 添加种子到房间物品列表
            const room = game.rooms[game.gameState.currentRoom];
            if (!room.items.includes('seed_of_love')) {
                room.items.push('seed_of_love');
            }
            
            // 创建种子掉落动画
            const seed = document.createElement('div');
            seed.id = 'seedDrop';
            seed.className = 'seed-drop-item';
            seed.style.position = 'absolute';
            seed.style.left = '50%';
            seed.style.top = '50%';
            seed.style.transform = 'translate(-50%, -50%)';
            seed.style.fontSize = '60px';
            seed.style.zIndex = '25';
            seed.style.cursor = 'pointer';
            seed.style.animation = 'seedDrop 2s ease-out forwards';
            seed.style.filter = 'drop-shadow(0 8px 15px rgba(0,0,0,0.8))';
            seed.textContent = '🌱';
            seed.title = 'Click to pick up';
            seed.setAttribute('data-tooltip', 'Click to pick up');
            
            // 添加点击事件
            seed.onclick = (e) => {
                e.stopPropagation();
                // 直接执行游戏逻辑，确保一次性完成
                const result = game.processCommand('take seed');
                if (result.type === 'success') {
                    addToHistory(result.message, 'success-message');
                    createParticles('light', 30);
                    seed.remove();
                    
                    // 从房间物品列表中移除种子，防止重新显示
                    const room = game.rooms[game.gameState.currentRoom];
                    if (room && room.items.includes('seed_of_love')) {
                        room.items = room.items.filter(item => item !== 'seed_of_love');
                    }
                    
                    // 立即更新背包和收集进度显示
                    updateInventory();
                    updateSymbols();
                    console.log('Seed picked up, inventory updated:', game.gameState.inventory);
                } else {
                    addToHistory(result.message, 'error-message');
                }
            };
            
            // 添加悬停效果
            seed.onmouseover = () => {
                seed.style.transform = 'translate(-50%, -50%) scale(1.1)';
                seed.style.filter = 'drop-shadow(0 12px 25px rgba(0,0,0,1))';
            };
            
            seed.onmouseout = () => {
                seed.style.transform = 'translate(-50%, -50%) scale(1)';
                seed.style.filter = 'drop-shadow(0 8px 15px rgba(0,0,0,0.8))';
            };
            
            // 添加种子掉落动画和悬停样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes seedDrop {
                    0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
                    60% { transform: translate(-50%, -50%) scale(1.2) rotate(180deg); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1) rotate(360deg); opacity: 1; }
                }
                
                /* 种子悬停提示样式 */
                .seed-drop-item[data-tooltip]:hover::after {
                    content: attr(data-tooltip);
                    position: absolute;
                    bottom: 100%;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: #4ecdc4;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 11px;
                    font-weight: bold;
                    white-space: nowrap;
                    z-index: 1000;
                    pointer-events: none;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
                    border: 1px solid #4ecdc4;
                    animation: tooltipFadeIn 0.3s ease-out;
                }
                
                .seed-drop-item[data-tooltip]:hover::before {
                    content: '';
                    position: absolute;
                    bottom: 100%;
                    left: 50%;
                    transform: translateX(-50%);
                    border: 3px solid transparent;
                    border-top-color: #4ecdc4;
                    z-index: 1000;
                    pointer-events: none;
                    animation: tooltipFadeIn 0.3s ease-out;
                }
                
                @keyframes tooltipFadeIn {
                    0% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
                    100% { opacity: 1; transform: translateX(-50%) translateY(0); }
                }
            `;
            document.head.appendChild(style);
            
            document.getElementById('objectsLayer').appendChild(seed);
            createParticles('light', 30);
            
            // 显示提示信息
            setTimeout(() => {
                addToHistory("🌱 Seed of Love drops in front of you!", 'success-message');
                addToHistory("(Click the 🌱 icon to pick up, or type 'take seed' command)", 'hint-text');
            }, 2000);
        }

        // Update Stone Position - STATE SWITCHING SYSTEM
        function updateStonePosition() {
            const stoneContainer = document.getElementById('stoneContainer');
            if (!stoneContainer) {
                console.log('❌ stoneContainer not found!');
                return;
            }
            
            console.log('🪨 Updating stone position, push count:', stonePushPosition);
            
            // 获取屏幕尺寸
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const centerX = screenWidth / 2;
            const centerY = screenHeight / 2;
            
            // 计算移动范围（屏幕高度的60%，增加移动范围）
            const moveRange = screenHeight * 0.6;
            
            // 根据推动次数设置石头位置 - 按照您的要求
            switch(stonePushPosition) {
                case 0:
                    // 初始状态：山的中央
                    console.log('📍 初始状态：石头在山的中央');
                    stoneContainer.style.left = (centerX - 40) + 'px';
                    stoneContainer.style.top = (centerY - 40) + 'px';
                    break;
                    
                case 1:
                    // Push 1: 石头在山底
                    console.log('📍 第1次推：石头在山底');
                    stoneContainer.style.left = (centerX - 40) + 'px';
                    stoneContainer.style.top = (centerY - 40 + moveRange * 0.5) + 'px'; // 山底 - 增加到0.5
                    break;
                    
                case 2:
                    // Push 2: 石头在山底往上一点点
                    console.log('📍 第2次推：石头在山底往上一点点');
                    stoneContainer.style.left = (centerX - 40) + 'px';
                    stoneContainer.style.top = (centerY - 40 + moveRange * 0.35) + 'px'; // 增加范围
                    break;
                    
                case 3:
                    // Push 3: 石头再往上一点
                    console.log('📍 第3次推：石头再往上一点');
                    stoneContainer.style.left = (centerX - 40) + 'px';
                    stoneContainer.style.top = (centerY - 40 - moveRange * 0.1) + 'px'; // 移到中央上方
                    break;
                    
                case 4:
                    // Push 4: 石头下面一些的位置
                    console.log('📍 第4次推：石头在下面一些的位置');
                    stoneContainer.style.left = (centerX - 40) + 'px';
                    stoneContainer.style.top = (centerY - 40 + moveRange * 0.2) + 'px'; // 回落
                    break;
                    
                case 5:
                    // Push 5: 石头再往上一点点
                    console.log('📍 第5次推：石头再往上一点点');
                    stoneContainer.style.left = (centerX - 40) + 'px';
                    stoneContainer.style.top = (centerY - 40 - moveRange * 0.25) + 'px'; // 最终上升，比之前更高
                    setTimeout(() => {
                        showStoneDrop();
                    }, 500);
                    break;
            }
        }

        // Roll Stone Back - 不需要了，因为我们现在使用状态切换
        function rollStoneBack() {
            // 这个函数现在不需要做任何事情
            // 因为位置已经通过updateStonePosition()正确设置了
        }

        // Show Bird Double Click Hint
        function showBirdDoubleClickHint() {
            // 防止重复创建
            const existingHint = document.getElementById('birdHintText');
            if (existingHint) return;
            
            // 创建提示容器
            const hint = document.createElement('div');
            hint.id = 'birdHintText';
            hint.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, rgba(78, 205, 196, 0.95), rgba(100, 220, 200, 0.95));
                color: #fff;
                padding: 16px 24px;
                padding-right: 45px;
                border-radius: 12px;
                border: none;
                font-size: 16px;
                font-weight: 600;
                z-index: 10000;
                pointer-events: auto;
                text-align: left;
                box-shadow: 0 8px 32px rgba(78, 205, 196, 0.4), 0 2px 8px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
                animation: toastSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                transition: all 0.3s ease;
                cursor: pointer;
                max-width: 320px;
            `;
            
            // 提示内容
            hint.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 24px; flex-shrink: 0;">🕊️</span>
                    <span style="line-height: 1.4;">双击背包中的小鸟来放生它！</span>
                </div>
            `;
            
            // 创建关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.style.cssText = `
                position: absolute;
                top: 50%;
                right: 12px;
                transform: translateY(-50%);
                background: rgba(255, 255, 255, 0.3);
                border: none;
                color: #fff;
                font-size: 24px;
                font-weight: bold;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                line-height: 1;
                padding: 0;
            `;
            
            closeBtn.onmouseover = () => {
                closeBtn.style.background = 'rgba(255, 255, 255, 0.5)';
                closeBtn.style.transform = 'translateY(-50%) scale(1.1)';
            };
            closeBtn.onmouseout = () => {
                closeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
                closeBtn.style.transform = 'translateY(-50%) scale(1)';
            };
            
            // 点击关闭按钮或提示框关闭
            const removeHint = () => {
                hint.style.animation = 'toastSlideOut 0.3s ease-out forwards';
                setTimeout(() => {
                    if (hint.parentNode) {
                        hint.parentNode.removeChild(hint);
                    }
                }, 300);
            };
            
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                removeHint();
            };
            
            hint.onclick = removeHint;
            
            hint.appendChild(closeBtn);
            
            // 添加动画样式
            if (!document.getElementById('toastAnimationStyle')) {
            const style = document.createElement('style');
                style.id = 'toastAnimationStyle';
            style.textContent = `
                    @keyframes toastSlideIn {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes toastSlideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                }
            `;
            document.head.appendChild(style);
            }
            
            // 添加到页面
            document.body.appendChild(hint);
            
            // 监听释放小鸟的操作，完成后自动关闭
            const checkBirdReleased = setInterval(() => {
                if (game.gameState.birdReleased) {
                    clearInterval(checkBirdReleased);
                    removeHint();
                }
            }, 100);
            
            // 存储清理函数和定时器ID，以便需要时清理
            hint.dataset.intervalId = checkBirdReleased;
        }

        // Show Torch Double Click Hint
        function showTorchDoubleClickHint() {
            // 防止重复创建
            const existingHint = document.getElementById('torchHintText');
            if (existingHint) return;
            
            // 创建提示容器
            const hint = document.createElement('div');
            hint.id = 'torchHintText';
            hint.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, rgba(255, 193, 7, 0.95), rgba(255, 152, 0, 0.95));
                color: #fff;
                padding: 16px 24px;
                padding-right: 45px;
                border-radius: 12px;
                border: none;
                font-size: 16px;
                font-weight: 600;
                z-index: 10000;
                pointer-events: auto;
                text-align: left;
                box-shadow: 0 8px 32px rgba(255, 193, 7, 0.4), 0 2px 8px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
                animation: toastSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                transition: all 0.3s ease;
                cursor: pointer;
                max-width: 320px;
            `;
            
            // 提示内容
            hint.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 24px; flex-shrink: 0;">💡</span>
                    <span style="line-height: 1.4;">双击背包中的手电筒来使用它！</span>
                </div>
            `;
            
            // 创建关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.style.cssText = `
                position: absolute;
                top: 50%;
                right: 12px;
                transform: translateY(-50%);
                background: rgba(255, 255, 255, 0.3);
                border: none;
                color: #fff;
                font-size: 24px;
                font-weight: bold;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                line-height: 1;
                padding: 0;
            `;
            
            closeBtn.onmouseover = () => {
                closeBtn.style.background = 'rgba(255, 255, 255, 0.5)';
                closeBtn.style.transform = 'translateY(-50%) scale(1.1)';
            };
            closeBtn.onmouseout = () => {
                closeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
                closeBtn.style.transform = 'translateY(-50%) scale(1)';
            };
            
            // 点击关闭按钮或提示框关闭
            const removeHint = () => {
                hint.style.animation = 'toastSlideOut 0.3s ease-out forwards';
            setTimeout(() => {
                if (hint.parentNode) {
                    hint.parentNode.removeChild(hint);
                }
                }, 300);
            };
            
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                removeHint();
            };
            
            hint.onclick = removeHint;
            
            hint.appendChild(closeBtn);
            
            // 确保动画样式已添加（如果之前没有添加）
            if (!document.getElementById('toastAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'toastAnimationStyle';
                style.textContent = `
                    @keyframes toastSlideIn {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes toastSlideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 添加到页面
            document.body.appendChild(hint);
            
            // 监听手电筒使用的操作，完成后自动关闭
            const checkTorchLit = setInterval(() => {
                if (game.gameState.itemStates.torch_lit) {
                    clearInterval(checkTorchLit);
                    removeHint();
                }
            }, 100);
            
            // 存储清理函数和定时器ID，以便需要时清理
            hint.dataset.intervalId = checkTorchLit;
        }

        // Show Stone Drop - 完全重写，简单可靠的版本
        function showStoneDrop() {
            // 清理所有旧的石头元素
            const oldStone = document.getElementById('stoneDrop');
            if (oldStone) {
                oldStone.remove();
            }
            
            // 添加石头到房间物品列表
            const room = game.rooms[game.gameState.currentRoom];
            if (!room.items.includes('stone_of_grit')) {
                room.items.push('stone_of_grit');
            }
            
            // 创建一个石头元素，使用与其他物品相同的样式
            const stone = document.createElement('div');
            stone.id = 'stoneDrop';
            stone.className = 'scene-object item';
            stone.style.position = 'fixed';
            stone.style.left = '50%';
            stone.style.top = '30%';
            stone.style.transform = 'translate(-50%, -50%)';
            stone.style.zIndex = '9999';
            stone.style.cursor = 'pointer';
            stone.style.fontSize = '60px';
            stone.style.color = '#8B4513';
            stone.textContent = '🗿';
            
            // 添加悬停提示
            const hint = document.createElement('div');
            hint.className = 'interaction-hint';
            hint.textContent = '✋ Click to pick up';
            stone.appendChild(hint);
            
            // 点击事件
            stone.addEventListener('click', function() {
                console.log('Stone clicked!');
                
                // 执行take stone命令
                const result = game.processCommand('take stone');
                console.log('Take stone result:', result);
                
                if (result.type === 'success') {
                    addToHistory(result.message, 'success-message');
                    createParticles('light', 30);
                    
                    // 立即移除石头元素
                    stone.remove();
                    
                    // 清理房间物品列表中的stone_of_grit，防止重新显示
                    const room = game.rooms[game.gameState.currentRoom];
                    if (room && room.items) {
                        room.items = room.items.filter(item => item !== 'stone_of_grit');
                    }
                    
                    // 立即更新背包和收集进度显示
                    updateInventory();
                    updateSymbols();
                    console.log('Inventory updated:', game.gameState.inventory);
                } else {
                    addToHistory(result.message, 'error-message');
                }
            });
            
            // 悬停效果
            stone.addEventListener('mouseenter', function() {
                stone.style.transform = 'translate(-50%, -50%) scale(1.1)';
                stone.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.8)';
            });
            
            stone.addEventListener('mouseleave', function() {
                stone.style.transform = 'translate(-50%, -50%) scale(1)';
                stone.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.5)';
            });
            
            // 添加到页面
            document.body.appendChild(stone);
            createParticles('magic', 50);
            
            // 显示提示
            setTimeout(() => {
                addToHistory("🗿 Stone Fragment of Grit drops in front of you!", 'success-message');
                addToHistory("(Click the 🗿 icon to pick up)", 'hint-text');
            }, 1000);
        }

        // Create Atmosphere Effects
        function createAtmosphereEffects(roomId) {
            const layer = document.getElementById('atmosphereLayer');
            layer.innerHTML = '';
            
            const effectsConfig = {
                courtyard_start: { count: 4, color: 'rgba(255, 215, 0, 0.1)', size: [70, 130] },
                cave: { count: 3, color: 'rgba(255, 100, 0, 0.12)', size: [50, 100] },
                forest: { count: 5, color: 'rgba(0, 255, 100, 0.08)', size: [90, 180] },
                library: { count: 4, color: 'rgba(100, 100, 255, 0.1)', size: [70, 130] },
                theater: { count: 3, color: 'rgba(200, 0, 0, 0.12)', size: [100, 200] },
                stone_circle: { count: 2, color: 'rgba(100, 100, 100, 0.12)', size: [70, 140] },
                garden: { count: 5, color: 'rgba(255, 182, 193, 0.1)', size: [60, 130] },
                courtyard_finale: { count: 5, color: 'rgba(255, 215, 0, 0.12)', size: [90, 170] }
            };
            
            const config = effectsConfig[roomId];
            if (!config) return;
            
            for (let i = 0; i < config.count; i++) {
                const effect = document.createElement('div');
                effect.className = 'atmosphere-effect';
                effect.style.left = `${Math.random() * 100}%`;
                effect.style.top = `${Math.random() * 100}%`;
                effect.style.width = `${Math.random() * (config.size[1] - config.size[0]) + config.size[0]}px`;
                effect.style.height = effect.style.width;
                effect.style.background = config.color;
                effect.style.animationDelay = `${Math.random() * 5}s`;
                effect.style.animationDuration = `${8 + Math.random() * 8}s`;
                layer.appendChild(effect);
            }
        }

        // Create Ambient Particles
        function createAmbientParticles(roomId) {
            const particleTypes = {
                courtyard_start: { type: 'light', count: 10 },
                courtyard_finale: { type: 'light', count: 12 },
                cave: { type: 'flame', count: 5 },
                library: { type: 'star', count: 12 },
                theater: { type: 'magic', count: 8 },
                garden: { type: 'light', count: 10 }
            };
            
            const config = particleTypes[roomId];
            if (config) {
                createParticles(config.type, config.count);
            }
        }

        // Create NPC Element
        function createNPC(npcId, npcData) {
            const npcEl = document.createElement('div');
            npcEl.className = 'scene-object npc';
            npcEl.style.left = `${npcData.position.x}%`;
            npcEl.style.top = `${npcData.position.y}%`;
            npcEl.style.transform = 'translate(-50%, -50%)';
            
            const avatar = document.createElement('div');
            avatar.className = 'npc-avatar';
            avatar.style.background = `linear-gradient(135deg, ${npcData.color}, ${adjustColor(npcData.color, -30)})`;
            avatar.textContent = npcData.emoji;
            
            const name = document.createElement('div');
            name.className = 'npc-name';
            name.textContent = npcs[npcId]?.name || npcId;
            
            const hint = document.createElement('div');
            hint.className = 'interaction-hint';
            hint.textContent = '💬 Click to talk';
            
            npcEl.appendChild(hint);
            npcEl.appendChild(avatar);
            npcEl.appendChild(name);
            
            npcEl.onclick = (e) => {
                e.stopPropagation();
                const rect = npcEl.getBoundingClientRect();
                createParticles('magic', 15, { 
                    x: rect.left + rect.width / 2, 
                    y: rect.top + rect.height / 2 
                });
                
                // 特殊处理courtyard_finale的guide对话
                if (npcId === 'guide' && game.gameState.currentRoom === 'courtyard_finale') {
                    console.log('🎭 Direct guide dialogue in courtyard_finale');
                    // 直接显示对话框，不通过executeCommand
                    if (!game.gameState.courtyardFinalTalked) {
                        console.log('🎭 First dialogue with guide');
                        showGuideFinalDialogue('', false);
                    } else {
                        console.log('🎭 Second dialogue with guide');
                        showGuideFinalDialogue('', true);
                    }
                } else {
                    // 其他NPC使用统一的talk命令处理
                executeCommand(`talk ${npcId}`);
                }
            };
            
            return npcEl;
        }

        // Create Item Element
        function createItem(itemId, itemData) {
            const itemEl = document.createElement('div');
            itemEl.className = 'scene-object item';
            itemEl.style.left = `${itemData.position.x}%`;
            itemEl.style.top = `${itemData.position.y}%`;
            itemEl.style.transform = 'translate(-50%, -50%)';
            itemEl.textContent = itemData.emoji;
            
            const hint = document.createElement('div');
            hint.className = 'interaction-hint';
            hint.textContent = itemData.hint || '✋ Click to pick up';
            itemEl.appendChild(hint);
            
            itemEl.onclick = (e) => {
                e.stopPropagation();
                const rect = itemEl.getBoundingClientRect();
                createParticles('light', 20, { 
                    x: rect.left + rect.width / 2, 
                    y: rect.top + rect.height / 2 
                });
                executeCommand(`take ${itemId}`);
            };
            
            return itemEl;
        }

        // Update Navigation Buttons
        function updateNavigationButtons() {
            const container = document.getElementById('navigationContainer');
            container.innerHTML = '';
            
            const room = rooms[game.gameState.currentRoom];
            const directions = {
                north: '⬆️',
                south: '⬇️',
                east: '➡️',
                west: '⬅️'
            };
            
            Object.keys(room.exits).forEach(direction => {
                const btn = document.createElement('div');
                btn.className = `nav-button ${direction}`;
                btn.textContent = directions[direction];
                btn.title = `前往 ${room.exits[direction]}`;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    createParticles('light', 25);
                    executeCommand(`go ${direction}`);
                };
                container.appendChild(btn);
            });
        }

        // Update Inventory
        function updateInventory() {
            const inventoryList = document.getElementById('inventoryList');
            
            if (game.gameState.inventory.length === 0) {
                inventoryList.innerHTML = '<p class="system-message">Empty</p>';
            } else {
                inventoryList.innerHTML = game.gameState.inventory.map(item => {
                    const itemData = items[item];
                    const visual = itemVisuals[item] || { emoji: '📦' };
                    return `<div class="inventory-item" 
                                 data-item-id="${item}"
                                 ondblclick="handleInventoryDoubleClick('${item}')"
                                 title="${itemData.description}">
                        <span class="inventory-item-icon">${visual.emoji}</span>
                        <span class="inventory-item-name">${itemData.name}</span>
                    </div>`;
                }).join('');
            }
        }

        // Handle Inventory Double Click
        function handleInventoryDoubleClick(itemId) {
            if (itemId === 'torch' && game.gameState.currentRoom === 'cave' && !game.gameState.itemStates.torch_lit) {
                addToHistory("💡 Double-click to use the flashlight!", "system-message");
                executeCommand('use torch');
            } else if (itemId === 'bird' && game.gameState.currentRoom === 'forest' && !game.gameState.birdReleased) {
                addToHistory("🕊️ Double-click to release the bird!", "system-message");
                executeCommand('release');
            }
        }

        // Update Symbols
        function updateSymbols() {
            const symbolsGrid = document.getElementById('symbolsGrid');
            const symbolsList = [
                { id: 'flame_of_courage', emoji: '🔥', title: 'Flame of Courage' },
                { id: 'feather_of_freedom', emoji: '🪶', title: 'Feather of Freedom' },
                { id: 'shield_of_wisdom', emoji: '🛡️', title: 'Shield of Wisdom' },
                { id: 'orb_of_creation', emoji: '🔮', title: 'Orb of Creation' },
                { id: 'stone_of_grit', emoji: '🪨', title: 'Stone of Grit' },
                { id: 'seed_of_love', emoji: '🌱', title: 'Seed of Love' }
            ];
            
            symbolsGrid.innerHTML = symbolsList.map(symbol => {
                const obtained = game.gameState.inventory.includes(symbol.id);
                return `<div class="symbol ${obtained ? 'obtained' : ''}" 
                            title="${symbol.title}">
                            ${obtained ? symbol.emoji : ''}
                        </div>`;
            }).join('');
        }

        // Dialog Functions
        function showDialog(npcId, isConversationEnd = false) {
            const modal = document.getElementById('dialogModal');
            const overlay = document.getElementById('dialogOverlay');
            const npcData = npcVisuals[npcId];
            
            if (npcData) {
                document.getElementById('dialogAvatar').textContent = npcData.emoji;
                document.getElementById('dialogAvatar').style.background = 
                    `linear-gradient(135deg, ${npcData.color}, ${adjustColor(npcData.color, -30)})`;
                document.getElementById('dialogName').textContent = npcs[npcId]?.name || npcId;
            }
            
            // 控制按钮显示
            const respondBtn = document.querySelector('.dialog-btn.respond');
            const endBtn = document.querySelector('.dialog-btn.end');
            
            if (isConversationEnd) {
                respondBtn.style.display = 'none';
                endBtn.style.display = 'block';
            } else {
                respondBtn.style.display = 'block';
                endBtn.style.display = 'block';
            }
            
            modal.style.display = 'block';
            overlay.style.display = 'block';
            createParticles('magic', 30);
        }

        function hideDialog() {
            if (!game.gameState.inConversation) {
                closeDialog();
            }
        }

        function closeDialog() {
            document.getElementById('dialogModal').style.display = 'none';
            document.getElementById('dialogOverlay').style.display = 'none';
        }

        // Command Input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                const command = document.getElementById('commandInput').value.trim();
                if (command) {
                    executeCommand(command);
                    document.getElementById('commandInput').value = '';
                }
            }
        }

        // Execute Command
        function executeCommand(command) {
            addToHistory(`> ${command}`);
            
            // Special handling for theater stage
            if (command.toLowerCase() === 'stage' && game.gameState.currentRoom === 'theater') {
                if (game.gameState.theaterTalked.has('einstein') && game.gameState.theaterTalked.has('marx')) {
                    theaterStageActive = true;
                    showTheaterChoices();
                    addToHistory("Stage lights up! Choose what you want to create.", "success-message");
                    // 隐藏舞台图标
                    const stageIcon = document.querySelector('[data-item-id="stage"]');
                    if (stageIcon) {
                        stageIcon.style.display = 'none';
                    }
                    return;
                }
            }
            
            // Special handling for theater creation
            if (command.toLowerCase().startsWith('create ')) {
                const choice = command.toLowerCase().split(' ')[1];
                if (['star', 'tree', 'castle'].includes(choice) && theaterStageActive) {
                    theaterChoice = choice;
                    theaterCreationStep = 1;
                    hideTheaterChoices();
                    showTheaterCreation(choice, 1);
                    addToHistory(getCreationMessage(choice, 1), 'success-message');
                    return; // 不继续执行游戏逻辑
                } else if (['star', 'tree', 'castle'].includes(choice) && !theaterStageActive) {
                    addToHistory("You are not on the stage.", 'error-message');
                    return;
                }
            }
            
            if (command.toLowerCase() === 'continue' && theaterStageActive && theaterChoice) {
                theaterCreationStep++;
                if (theaterCreationStep <= 3) {
                    showTheaterCreation(theaterChoice, theaterCreationStep);
                    addToHistory(getCreationMessage(theaterChoice, theaterCreationStep), 'success-message');
                    if (theaterCreationStep < 3) {
                        addToHistory("(Type 'continue' to proceed or 'cancel' to choose again)", 'hint-text');
                    }
                }
                return; // 不继续执行游戏逻辑
            }
            
            // Special handling for push stone - 只处理视觉更新，不干扰游戏逻辑
            if (command.toLowerCase() === 'push stone' && game.gameState.currentRoom === 'stone_circle') {
                console.log('🪨 Push stone command received!');
                
                // 先执行游戏逻辑
                const result = game.processCommand(command);
                
                if (result.type === 'success') {
                    // 同步HTML变量与游戏状态
                    stonePushPosition = game.gameState.stoneCirclePushCount;
                    console.log('🪨 Synced push position:', stonePushPosition);
                    updateStonePosition();
                    addToHistory(result.message, 'success-message');
                    
                    // 如果是第5次推动，更新房间显示以显示stone_of_grit
                    if (stonePushPosition === 5) {
                        setTimeout(() => {
                            updateRoomDisplay();
                        }, 1000); // 延迟1秒更新，让动画完成
                    }
                } else if (result.type === 'error') {
                    addToHistory(result.message, 'error-message');
                }
                
                return; // 不继续执行游戏逻辑
            }
            
            const result = game.processCommand(command);
            
            if (result.type === 'error') {
                addToHistory(result.message, 'error-message');
                createParticles('flame', 10);
            } else if (result.type === 'success') {
                // Dialog handling - 对话内容不添加到历史栏
                if (command.toLowerCase().startsWith('talk') && game.gameState.inConversation) {
                    // 特殊处理Guide的对话（开始和最终房间）
                    if (game.gameState.currentDialogueNpc === 'guide' && 
                        (game.gameState.currentRoom === 'courtyard_finale' || game.gameState.currentRoom === 'courtyard_start')) {
                        // 将对话内容添加到历史记录
                        addToHistory(result.message, 'success-message');
                        if (game.gameState.currentRoom === 'courtyard_finale') {
                            // 检查是否是第一次对话
                            console.log('🎭 courtyardFinalTalked:', game.gameState.courtyardFinalTalked);
                            if (!game.gameState.courtyardFinalTalked) {
                                console.log('🎭 First dialogue with guide');
                                showGuideFinalDialogue(result.message, false);
                    } else {
                                console.log('🎭 Second dialogue with guide');
                                // 第二次对话
                                showGuideFinalDialogue('', true);
                            }
                        } else {
                            showDialog(game.gameState.currentDialogueNpc);
                            document.getElementById('dialogContent').innerHTML = formatMessage(result.message);
                        }
                    } else {
                        // 将对话内容添加到历史记录
                        addToHistory(result.message, 'success-message');
                        
                        // 检查对话是否直接结束
                        const isConversationEnd = result.message.includes('(The conversation is over.)');
                        
                        if (isConversationEnd) {
                            // 设置对话状态为结束
                            game.gameState.inConversation = false;
                            showDialog(game.gameState.currentDialogueNpc, true);
                        } else {
                            showDialog(game.gameState.currentDialogueNpc);
                        }
                        
                        // 花园中的玫瑰对话结束后显示选择按钮（无论对话是否直接结束）
                        if (game.gameState.currentRoom === 'garden' && 
                            ['red', 'white', 'purple'].includes(game.gameState.currentDialogueNpc)) {
                            const selectButton = document.getElementById(`select-${game.gameState.currentDialogueNpc}`);
                            if (selectButton) {
                                selectButton.style.display = 'block';
                                console.log(`显示选择按钮: select-${game.gameState.currentDialogueNpc}`);
                            } else {
                                console.log(`找不到选择按钮: select-${game.gameState.currentDialogueNpc}`);
                            }
                        }
                        document.getElementById('dialogContent').innerHTML = formatMessage(result.message);
                    }
                } else if ((command.toLowerCase() === 'end' || command.toLowerCase() === 'respond') && 
                    game.gameState.inConversation) {
                    // 对话内容显示在对话框内，同时添加到历史栏
                    document.getElementById('dialogContent').innerHTML = formatMessage(result.message);
                    addToHistory(result.message, 'success-message');
                    
                    // 检查对话是否结束
                    const isConversationEnd = result.message.includes('(The conversation is over.)');
                    
                    if (isConversationEnd) {
                        // 设置对话状态为结束
                        game.gameState.inConversation = false;
                        showDialog(game.gameState.currentDialogueNpc, true);
                    }
                    
                    // 花园中的玫瑰对话结束后显示选择按钮（无论对话是否直接结束）
                    if (game.gameState.currentRoom === 'garden' && 
                        ['red', 'white', 'purple'].includes(game.gameState.currentDialogueNpc)) {
                        const selectButton = document.getElementById(`select-${game.gameState.currentDialogueNpc}`);
                        if (selectButton) {
                            selectButton.style.display = 'block';
                            console.log(`显示选择按钮: select-${game.gameState.currentDialogueNpc}`);
                        } else {
                            console.log(`找不到选择按钮: select-${game.gameState.currentDialogueNpc}`);
                        }
                    }
                    
                    // Bird fly away when birdShouldFlyAway flag is set
                    console.log('🐦 Checking bird fly away:', {
                        birdShouldFlyAway: game.gameState.birdShouldFlyAway,
                        currentDialogueNpc: game.gameState.currentDialogueNpc,
                        forestBirdEncouraged: game.gameState.forestBirdEncouraged
                    });
                    
                    if (game.gameState.birdShouldFlyAway && 
                        game.gameState.currentDialogueNpc === 'bird') {
                        console.log('🐦 Triggering bird fly away!');
                        handleBirdFlyAway();
                        // Reset the flag
                        game.gameState.birdShouldFlyAway = false;
                    }
                    
                    // Show feather drop when showFeatherDrop flag is set
                    if (game.gameState.showFeatherDrop && 
                        game.gameState.currentDialogueNpc === 'bird') {
                        console.log('🪶 Showing feather drop!');
                        showFeatherDrop();
                        // Reset the flag
                        game.gameState.showFeatherDrop = false;
                    }
                } else if (command.toLowerCase() === 'end' || 
                          (command.toLowerCase() === 'respond' && !game.gameState.inConversation)) {
                    // Check if bird should fly away when ending dialogue
                    if (game.gameState.currentDialogueNpc === 'bird' && 
                        game.gameState.forestBirdEncouraged) {
                        handleBirdFlyAway();
                    }
                    closeDialog();
                } else {
                    // 非对话内容才添加到历史栏
                    addToHistory(result.message, 'success-message');
                }
                
                // Garden planting actions - update display after each step
                if (['water', 'fertilize', 'weed', 'wish', 'wait'].includes(command.toLowerCase()) && 
                    game.gameState.currentRoom === 'garden' && game.gameState.gardenRoseChosen) {
                    setTimeout(() => {
                        updateRoomDisplay();
                    }, 100);
                }
                
                // Choose flower - 新的卡片选择处理
                if (command.toLowerCase().startsWith('choose ') && game.gameState.currentRoom === 'garden') {
                    const chosen = command.toLowerCase().split(' ')[1];
                    
                    // 隐藏选择提示
                    const choiceHint = document.getElementById('gardenChoiceHint');
                    if (choiceHint) {
                        choiceHint.style.display = 'none';
                    }
                    
                    // 立即隐藏所有卡片，显示选择效果
                        const cards = document.querySelectorAll('.garden-rose-card');
                        cards.forEach(card => {
                        card.style.animation = 'cardFadeOut 0.5s ease-out forwards';
                    });
                    
                    // 添加淡出动画
                    if (!document.getElementById('cardFadeOutStyle')) {
                                const style = document.createElement('style');
                        style.id = 'cardFadeOutStyle';
                                style.textContent = `
                            @keyframes cardFadeOut {
                                0% { 
                                    opacity: 1; 
                                    transform: translate(-50%, -50%) scale(1); 
                                }
                                100% { 
                                    opacity: 0; 
                                    transform: translate(-50%, -50%) scale(0.8); 
                                }
                                    }
                                `;
                                document.head.appendChild(style);
                    }
                    
                    // 延迟显示种植界面
                        setTimeout(() => {
                        // 清理所有卡片
                        cards.forEach(card => card.remove());
                        
                        // 显示种植界面
                        showGardenPlanting();
                        
                        // 添加选择成功的特效
                        createParticles('magic', 50);
                    }, 500);
                }
                
                // Repair disk - 特殊处理六芒星修复
                if (command.toLowerCase() === 'repair disk' && game.gameState.currentRoom === 'courtyard_finale') {
                    // 直接调用修复函数，不依赖game.js的检查
                    console.log('Repair disk command triggered');
                    showHexagramRepair();
                    addToHistory('Starting to repair the hexagram...', 'system-message');
                    return; // 直接返回，不执行后续的game.processCommand
                }
                
                // Game completion
                if (result.gameComplete) {
                    showVictoryScreen(result.message);
                }
                
                if (result.item) {
                    createParticles('light', 25);
                    
                    // 特殊处理：如果是torch，显示双击提示
                    if (result.item === 'torch') {
                        setTimeout(() => {
                            showTorchDoubleClickHint();
                        }, 1000);
                    }
                    
                    // 特殊处理：拾取物品后更新房间显示
                    if (command.toLowerCase().startsWith('take')) {
                        setTimeout(() => {
                            updateRoomDisplay();
                            // 立即更新背包和收集进度显示
                            updateInventory();
                            updateSymbols();
                            
                            // 特殊处理stone of grit的拾取
                            if (command.toLowerCase().includes('stone') && game.gameState.currentRoom === 'stone_circle') {
                                // 移除可能存在的stone drop元素
                                const stoneDrop = document.getElementById('stoneDrop');
                                if (stoneDrop) {
                                    stoneDrop.remove();
                                }
                                // 移除通过updateRoomDisplay创建的stone_of_grit物品元素
                                const stoneItems = document.querySelectorAll('[data-item-id="stone_of_grit"]');
                                stoneItems.forEach(item => item.remove());
                            }
                            
                            // 特殊处理seed of love的拾取
                            if (command.toLowerCase().includes('seed') && game.gameState.currentRoom === 'garden') {
                                // 移除可能存在的seed drop元素
                                const seedDrop = document.getElementById('seedDrop');
                                if (seedDrop) {
                                    seedDrop.remove();
                                }
                                // 移除通过updateRoomDisplay创建的seed_of_love物品元素
                                const seedItems = document.querySelectorAll('[data-item-id="seed_of_love"]');
                                seedItems.forEach(item => item.remove());
                                
                                // 从房间物品列表中移除种子，防止重新显示
                                const room = game.rooms[game.gameState.currentRoom];
                                if (room && room.items.includes('seed_of_love')) {
                                    room.items = room.items.filter(item => item !== 'seed_of_love');
                                }
                            }
                            
                            // 特殊处理orb of creation的拾取
                            if (command.toLowerCase().includes('orb') && game.gameState.currentRoom === 'theater') {
                                console.log('🔮 Processing orb pickup in theater');
                                // 移除可能存在的orb drop元素
                                const orbDrop = document.getElementById('orbDrop');
                                if (orbDrop) {
                                    console.log('🔮 Removing orb drop element');
                                    orbDrop.remove();
                                }
                                // 移除通过updateRoomDisplay创建的orb_of_creation物品元素
                                const orbItems = document.querySelectorAll('[data-item-id="orb_of_creation"]');
                                orbItems.forEach(item => {
                                    console.log('🔮 Removing orb item element');
                                    item.remove();
                                });
                                
                                // 确保orb被添加到背包中
                                if (!game.gameState.inventory.includes('orb_of_creation')) {
                                    game.gameState.inventory.push('orb_of_creation');
                                    console.log('🔮 Orb added to inventory');
                                }
                                
                                // 从房间物品列表中移除orb，防止重新显示
                                const room = game.rooms[game.gameState.currentRoom];
                                if (room && room.items.includes('orb_of_creation')) {
                                    room.items = room.items.filter(item => item !== 'orb_of_creation');
                                    console.log('🔮 Orb removed from room items array');
                                }
                            }
                            
                            // 特殊处理shield of wisdom的拾取
                            if (command.toLowerCase().includes('shield') && game.gameState.currentRoom === 'library') {
                                // 确保盾牌被添加到背包中
                                if (!game.gameState.inventory.includes('shield_of_wisdom')) {
                                    game.gameState.inventory.push('shield_of_wisdom');
                                    console.log('🛡️ Shield added to inventory');
                                }
                                
                                // 移除通过updateRoomDisplay创建的shield_of_wisdom物品元素
                                const shieldItems = document.querySelectorAll('[data-item-id="shield_of_wisdom"]');
                                shieldItems.forEach(item => {
                                    console.log('🛡️ Removing shield item element');
                                    item.remove();
                                });
                                
                                // 从房间物品列表中移除盾牌，防止重新显示
                                const room = game.rooms[game.gameState.currentRoom];
                                if (room && room.items.includes('shield_of_wisdom')) {
                                    room.items = room.items.filter(item => item !== 'shield_of_wisdom');
                                    console.log('🛡️ Shield removed from room items array');
                                }
                                
                                // 确保盾牌不会重新出现
                                game.gameState.shieldPickedUp = true;
                                console.log('🛡️ Shield picked up, marked as collected');
                                
                                // 立即更新背包和收集进度显示
                                updateInventory();
                                updateSymbols();
                            }
                        }, 100); // 短暂延迟确保游戏状态已更新
                    }
                }
                
                // Library path completed
                if (['learn', 'live', 'dialogue', 'reflect'].includes(command.toLowerCase()) && 
                    game.gameState.currentRoom === 'library') {
                    setTimeout(() => {
                        updateRoomDisplay();
                    }, 500);
                }
                
                // Theater dialogue completed - check if stage should appear
                if (game.gameState.currentRoom === 'theater' && 
                    game.gameState.theaterTalked.has('einstein') && 
                    game.gameState.theaterTalked.has('marx') &&
                    !game.gameState.inventory.includes('orb_of_creation') &&
                    !theaterStageActive) {
                    console.log('🎭 Theater dialogue completed, checking for stage display');
                    
                    // 立即检查并显示舞台图标
                    const existingStage = document.querySelector('[data-item-id="stage"]');
                    if (!existingStage) {
                        console.log('🎭 Stage icon missing, creating immediately');
                        createTheaterStageIcon();
                    } else {
                        console.log('🎭 Stage icon already exists');
                    }
                    
                    // 额外的保险措施
                    setTimeout(() => {
                        const stageCheck = document.querySelector('[data-item-id="stage"]');
                        if (!stageCheck) {
                            console.log('🎭 Stage icon still missing after delay, forcing display');
                            createTheaterStageIcon();
                        }
                    }, 50);
                }
            } else if (result.type === 'move') {
                createParticles('magic', 35);
                
                // 房间切换前的额外清理
                console.log('🚪 Room switching, performing extra cleanup...');
                
                // 清理所有可能的残留元素
                const allDropElements = ['stoneDrop', 'seedDrop', 'orbDrop', 'shieldDrop'];
                allDropElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        console.log(`🧹 Extra cleanup: removing ${id}`);
                        element.remove();
                    }
                });
                
                // 清理剧院特有元素
                const theaterStages = document.querySelectorAll('[data-item-id="stage"]');
                theaterStages.forEach(element => {
                    console.log('🧹 Extra cleanup: removing theater stage');
                    element.remove();
                });
                
                // 清理剧院容器内容
                const theaterChoices = document.getElementById('theaterChoices');
                if (theaterChoices) {
                    theaterChoices.innerHTML = '';
                    console.log('🧹 Extra cleanup: cleared theater choices');
                }
                
                const theaterCreation = document.getElementById('theaterCreation');
                if (theaterCreation) {
                    theaterCreation.innerHTML = '';
                    console.log('🧹 Extra cleanup: cleared theater creation');
                }
                
                // 强制清空objectsLayer
                const objectsLayer = document.getElementById('objectsLayer');
                if (objectsLayer) {
                    objectsLayer.innerHTML = '';
                    console.log('🧹 Extra cleanup: cleared objectsLayer');
                }
                
                updateRoomDisplay();
                addToHistory(result.message, 'success-message');
                
                // 特殊处理：如果进入森林且有bird，显示双击提示
                if (result.room === 'forest' && game.gameState.inventory.includes('bird')) {
                    setTimeout(() => {
                        showBirdDoubleClickHint();
                    }, 1000);
                }
                
                // 特殊处理：图书馆和剧院房间的显示问题
                if (result.room === 'library' || result.room === 'theater') {
                    console.log(`🏠 Entered ${result.room} room, ensuring content is displayed`);
                    
                    // 立即强制显示内容，不依赖updateRoomDisplay
                    if (result.room === 'library') {
                        console.log('📚 Force displaying library content immediately');
                        forceLibraryDisplay();
                    } else if (result.room === 'theater') {
                        console.log('🎭 Force displaying theater content immediately');
                        forceTheaterDisplay();
                    }
                    
                    // 多重验证和重试机制
                    const validateAndRetry = (attempt = 1) => {
                        const objectsLayer = document.getElementById('objectsLayer');
                        const hasContent = objectsLayer && objectsLayer.children.length > 0;
                        
                        console.log(`🔍 Validation attempt ${attempt}: hasContent=${hasContent}`);
                        
                        if (!hasContent && attempt <= 3) {
                            console.log(`🔧 ${result.room} room empty, retrying display (attempt ${attempt})`);
                            if (result.room === 'library') {
                                forceLibraryDisplay();
                            } else if (result.room === 'theater') {
                                forceTheaterDisplay();
                            }
                            
                            // 递归重试
                            setTimeout(() => validateAndRetry(attempt + 1), 100 * attempt);
                        } else if (hasContent) {
                            console.log(`✅ ${result.room} room content successfully displayed`);
                        } else {
                            console.error(`❌ ${result.room} room failed to display after 3 attempts`);
                        }
                    };
                    
                    // 立即验证
                    setTimeout(() => validateAndRetry(), 10);
                    
                    // 额外保险：延迟验证
                    setTimeout(() => validateAndRetry(), 100);
                }
            } else if (result.type === 'look') {
                addToHistory(result.description, 'system-message');
                
                if (result.items && result.items.length > 0) {
                    const itemList = result.items.map(item => {
                        const itemData = items[item];
                        return `  - ${itemData ? itemData.name : item}`;
                    }).join('\n');
                    addToHistory(`You see:\n${itemList}`, 'system-message');
                }
                
                if (result.npcs && result.npcs.length > 0) {
                    const npcList = result.npcs.map(npc => 
                        `  - ${npcs[npc]?.name || npc}`
                    ).join('\n');
                    addToHistory(`You also see:\n${npcList}`, 'system-message');
                } else {
                    addToHistory('You also see:\n  (no one)', 'system-message');
                }
                
                if (result.exits && Object.keys(result.exits).length > 0 && 
                    result.room !== 'courtyard_finale') {
                    addToHistory(`Exits: ${Object.keys(result.exits).join(', ')}`, 'system-message');
                }
                
                if (result.extraText) {
                    addToHistory(result.extraText, 'system-message');
                }
            } else if (result.type === 'info') {
                addToHistory(result.message, 'system-message');
                
            }
            
            // 检查小鸟是否需要飞走（在updateRoomDisplay之前）
            if (game.gameState.birdShouldFlyAway && 
                game.gameState.currentDialogueNpc === 'bird') {
                console.log('🐦 Triggering bird fly away from main logic!');
                handleBirdFlyAway();
                // Reset the flag
                game.gameState.birdShouldFlyAway = false;
            }
            
            // 检查羽毛是否需要掉落（在updateRoomDisplay之前）
            if (game.gameState.showFeatherDrop && 
                game.gameState.currentDialogueNpc === 'bird') {
                console.log('🪶 Showing feather drop from main logic!');
                showFeatherDrop();
                // Reset the flag
                game.gameState.showFeatherDrop = false;
            }
            
            updateInventory();
            updateSymbols();
            updateRoomDisplay();
            
            // 验证房间显示是否正确
            setTimeout(() => {
                validateRoomDisplay();
            }, 200);
        }
        
        // 创建剧院舞台图标
        function createTheaterStageIcon() {
            console.log('🎭 Creating theater stage icon');
            
            // 检查是否已经存在舞台图标
            const existingStage = document.querySelector('[data-item-id="stage"]');
            if (existingStage) {
                console.log('🎭 Stage icon already exists, removing old one');
                existingStage.remove();
            }
            
            const stageData = { emoji: '🎭', position: { x: 50, y: 65 }, hint: 'Click to ascend the stage' };
            const stageEl = createItem('stage', stageData);
            stageEl.setAttribute('data-item-id', 'stage');
            stageEl.onclick = () => {
                executeCommand('stage');
            };
            
            const objectsLayer = document.getElementById('objectsLayer');
            if (objectsLayer) {
                objectsLayer.appendChild(stageEl);
                console.log('🎭 Stage icon added to objectsLayer');
                
                // 验证添加成功
                setTimeout(() => {
                    const verifyStage = document.querySelector('[data-item-id="stage"]');
                    if (verifyStage) {
                        console.log('🎭 Stage icon verified and visible');
                    } else {
                        console.error('🎭 Stage icon creation failed!');
                    }
                }, 10);
            } else {
                console.error('🎭 objectsLayer not found!');
            }
        }
        
        // 刷新房间显示
        function refreshRoom() {
            console.log('手动刷新房间显示...');
            const currentRoom = game.gameState.currentRoom;
            console.log('🔄 Refreshing room:', currentRoom);
            
            // 强制清空并重新显示
            const objectsLayer = document.getElementById('objectsLayer');
            if (objectsLayer) {
                objectsLayer.innerHTML = '';
                console.log('🔄 Cleared objectsLayer');
            }
            
            // 根据房间类型进行特殊处理
            if (currentRoom === 'library') {
                console.log('🔄 Library room detected, using forceLibraryDisplay');
                console.log('🔄 Library state check:', {
                    hasShield: game.gameState.inventory.includes('shield_of_wisdom'),
                    pathsCompleted: game.gameState.libraryPaths.size,
                    shieldPickedUp: game.gameState.shieldPickedUp
                });
                forceLibraryDisplay();
                
                // 额外的验证和重试
                setTimeout(() => {
                    const libraryPaths = document.getElementById('libraryPaths');
                    if (!libraryPaths) {
                        console.log('🔄 Library paths still missing after forceLibraryDisplay, retrying...');
                        showLibraryPaths();
                    } else {
                        console.log('🔄 Library paths found after forceLibraryDisplay');
                    }
                }, 50);
            } else if (currentRoom === 'theater') {
                console.log('🔄 Theater room detected, using forceTheaterDisplay');
                forceTheaterDisplay();
                
                // 额外的剧院舞台图标检查
                setTimeout(() => {
                    const shouldHaveStage = game.gameState.theaterTalked.has('einstein') && 
                                           game.gameState.theaterTalked.has('marx') &&
                                           !game.gameState.inventory.includes('orb_of_creation') &&
                                           !theaterStageActive;
                    
                    if (shouldHaveStage) {
                        const existingStage = document.querySelector('[data-item-id="stage"]');
                        if (!existingStage) {
                            console.log('🔄 Theater stage icon missing after refresh, creating...');
                            createTheaterStageIcon();
                        } else {
                            console.log('🔄 Theater stage icon found after refresh');
                        }
                    }
                }, 100);
            } else {
                console.log('🔄 Using standard updateRoomDisplay');
                updateRoomDisplay();
            }
            
            // 验证显示结果
            setTimeout(() => {
                const objectsLayer = document.getElementById('objectsLayer');
                const hasContent = objectsLayer && objectsLayer.children.length > 0;
                console.log('🔄 Refresh result - hasContent:', hasContent, 'children:', objectsLayer?.children.length || 0);
                
                if (!hasContent) {
                    console.log('🔄 Refresh failed, trying validateRoomDisplay');
                    validateRoomDisplay();
                }
            }, 100);
            
            addToHistory('🔄 Room refreshed', 'system-message');
        }
        
        // Force Theater Display
        function forceTheaterDisplay() {
            if (game.gameState.currentRoom === 'theater') {
                console.log('🎭 Force refreshing theater room');
                const objectsLayer = document.getElementById('objectsLayer');
                
                // 确保objectsLayer存在且可见
                if (!objectsLayer) {
                    console.error('🎭 objectsLayer not found!');
                    return;
                }
                
                // 强制清空并重置
                objectsLayer.innerHTML = '';
                objectsLayer.style.display = 'block';
                objectsLayer.style.visibility = 'visible';
                
                // 如果已经获得orb，确保不显示orb相关元素
                if (game.gameState.inventory.includes('orb_of_creation')) {
                    console.log('🎭 Orb already obtained, not creating orb elements');
                }
                
                // Force create NPCs
                const room = rooms[game.gameState.currentRoom];
                console.log('🎭 Theater room NPCs:', room.npcs);
                room.npcs.forEach(npcId => {
                    const npcData = npcVisuals[npcId];
                    if (npcData) {
                        console.log(`Force creating NPC: ${npcId}`, npcData);
                        const npcEl = createNPC(npcId, npcData);
                        objectsLayer.appendChild(npcEl);
                        console.log(`🎭 NPC ${npcId} added to objectsLayer`);
                    } else {
                        console.warn(`🎭 No NPC data found for: ${npcId}`);
                    }
                });
                
                // Force create stage icon if conditions are met
                if (game.gameState.theaterTalked.has('einstein') && 
                    game.gameState.theaterTalked.has('marx') &&
                    !game.gameState.inventory.includes('orb_of_creation') &&
                    !theaterStageActive) {
                    console.log('🎭 Theater conditions met in forceTheaterDisplay, creating stage icon');
                    createTheaterStageIcon();
                } else {
                    console.log('🎭 Theater conditions not met in forceTheaterDisplay:', {
                        einstein: game.gameState.theaterTalked.has('einstein'),
                        marx: game.gameState.theaterTalked.has('marx'),
                        hasOrb: game.gameState.inventory.includes('orb_of_creation'),
                        stageActive: theaterStageActive
                    });
                }
                
                // 验证内容是否成功添加
                setTimeout(() => {
                    const hasContent = objectsLayer.children.length > 0;
                    console.log('🎭 Theater display verification:', {
                        objectsLayerChildren: objectsLayer.children.length,
                        hasContent: hasContent
                    });
                    
                    if (!hasContent) {
                        console.warn('🎭 Theater still empty, retrying...');
                        // 再次尝试创建NPCs
                        room.npcs.forEach(npcId => {
                            const npcData = npcVisuals[npcId];
                            if (npcData) {
                                const npcEl = createNPC(npcId, npcData);
                                objectsLayer.appendChild(npcEl);
                            }
                        });
                    }
                }, 50);
                
                console.log('🎭 ObjectsLayer children count:', objectsLayer.children.length);
                addToHistory("🎭 Theater room force refresh completed", "system-message");
            }
        }
        
        // Force Library Display
        function forceLibraryDisplay() {
            if (game.gameState.currentRoom === 'library') {
                console.log('📚 Force refreshing library room');
                const objectsLayer = document.getElementById('objectsLayer');
                
                // 确保objectsLayer存在且可见
                if (!objectsLayer) {
                    console.error('📚 objectsLayer not found!');
                    return;
                }
                
                // 强制清空并重置
                objectsLayer.innerHTML = '';
                objectsLayer.style.display = 'block';
                objectsLayer.style.visibility = 'visible';
                
                // Force create NPCs
                const room = rooms[game.gameState.currentRoom];
                console.log('📚 Library room NPCs:', room.npcs);
                room.npcs.forEach(npcId => {
                    const npcData = npcVisuals[npcId];
                    if (npcData) {
                        console.log(`Force creating NPC: ${npcId}`, npcData);
                        const npcEl = createNPC(npcId, npcData);
                        objectsLayer.appendChild(npcEl);
                        console.log(`📚 NPC ${npcId} added to objectsLayer`);
                    } else {
                        console.warn(`📚 No NPC data found for: ${npcId}`);
                    }
                });
                
                // Force create items
                console.log('📚 Library room items:', room.items);
                room.items.forEach(itemId => {
                    const itemData = itemVisuals[itemId];
                    if (itemData) {
                        console.log(`Force creating item: ${itemId}`, itemData);
                        const itemEl = createItem(itemId, itemData);
                        itemEl.setAttribute('data-item-id', itemId);
                        objectsLayer.appendChild(itemEl);
                        console.log(`📚 Item ${itemId} added to objectsLayer`);
                    }
                });
                
                // Force show library paths (always show, even if shield obtained)
                console.log('📚 Calling showLibraryPaths');
                showLibraryPaths();
                
                // 验证内容是否成功添加
                setTimeout(() => {
                    const libraryPaths = document.getElementById('libraryPaths');
                    const hasContent = objectsLayer.children.length > 0;
                    console.log('📚 Library display verification:', {
                        objectsLayerChildren: objectsLayer.children.length,
                        libraryPathsExists: !!libraryPaths,
                        hasContent: hasContent
                    });
                    
                    if (!hasContent) {
                        console.warn('📚 Library still empty, retrying...');
                        // 再次尝试
                        showLibraryPaths();
                    }
                }, 50);
                
                console.log('📚 ObjectsLayer children count:', objectsLayer.children.length);
                addToHistory("📚 Library room force refresh completed", "system-message");
            }
        }
        
        // 验证房间显示是否正确
        function validateRoomDisplay() {
            const objectsLayer = document.getElementById('objectsLayer');
            const room = rooms[game.gameState.currentRoom];
            
            if (!objectsLayer || !room) return;
            
            // 检查是否有内容显示
            const hasContent = objectsLayer.children.length > 0 || 
                              objectsLayer.innerHTML.trim() !== '';
            
            console.log(`🔍 Validating ${room.title}: hasContent=${hasContent}, npcs=${room.npcs.length}, items=${room.items.length}`);
            
            // 如果房间应该有NPC或物品但没有显示，强制重新加载
            if (!hasContent && (room.npcs.length > 0 || room.items.length > 0)) {
                console.warn(`🔧 Room display validation failed for ${room.title}, reloading...`);
                updateRoomDisplay();
            }
            
            // 特殊处理：图书馆和剧院房间的强制显示
            if (game.gameState.currentRoom === 'library') {
                // 图书馆房间应该总是有内容（路径或盾牌）
                const shouldHaveContent = !game.gameState.inventory.includes('shield_of_wisdom') || 
                                        game.gameState.libraryPaths.size > 0;
                if (!hasContent && shouldHaveContent) {
                    console.log('📚 Library room empty but should have content, forcing display...');
                    forceLibraryDisplay();
                } else if (hasContent) {
                    console.log('📚 Library room has content, checking if it\'s correct...');
                    // 检查是否有libraryPaths元素
                    const libraryPaths = document.getElementById('libraryPaths');
                    if (!libraryPaths && !game.gameState.inventory.includes('shield_of_wisdom')) {
                        console.log('📚 Library paths missing, forcing display...');
                        forceLibraryDisplay();
                    }
                }
            } else if (game.gameState.currentRoom === 'theater') {
                // 剧院房间特殊检查：如果对话完成但舞台图标缺失，强制创建
                const shouldHaveStage = game.gameState.theaterTalked.has('einstein') && 
                                       game.gameState.theaterTalked.has('marx') &&
                                       !game.gameState.inventory.includes('orb_of_creation') &&
                                       !theaterStageActive;
                
                if (shouldHaveStage) {
                    const existingStage = document.querySelector('[data-item-id="stage"]');
                    if (!existingStage) {
                        console.log('🎭 Theater stage icon missing but should exist, creating...');
                        createTheaterStageIcon();
                    } else {
                        console.log('🎭 Theater stage icon exists');
                    }
                }
                
                if (!hasContent) {
                    console.log('🎭 Theater room empty, forcing display...');
                    forceTheaterDisplay();
                }
            }
        }

        // Handle Bird Fly Away
        function handleBirdFlyAway() {
            console.log('🕊️ handleBirdFlyAway called');
            const birdEl = document.getElementById('releasedBird');
            console.log('🕊️ Bird element found:', !!birdEl);
            if (birdEl) {
                console.log('🕊️ Adding flying animation to bird');
                birdEl.classList.add('bird-flying-out');
                
                setTimeout(() => {
                    birdEl.remove();
                }, 2000);
            }
        }
        
        // Show Feather Drop
        function showFeatherDrop() {
            console.log('🪶 showFeatherDrop called');
                    
                    // Show feather drop message
                    addToHistory("The bird spreads its wings, soaring upward. A feather drifts down, landing gently at your feet.", 'success-message');
                    addToHistory("\nYou know, some birds are destined never to be kept in cages.\nEvery one of their feathers shines with the brilliance of freedom.", 'success-message');
                    addToHistory("\nPick up the feather—it is the bird's gift to you, and your proof of freedom.\n(Type 'take feather' to pick it up)", 'success-message');
                    
                    const room = rooms[game.gameState.currentRoom];
                    if (room.items.includes('feather_of_freedom')) {
                        const featherData = itemVisuals['feather_of_freedom'];
                        const featherEl = createItem('feather_of_freedom', featherData);
                        document.getElementById('objectsLayer').appendChild(featherEl);
                        createParticles('light', 30);
                console.log('🪶 Feather item created and added to scene');
            }
        }

        // Show Victory Screen
        function showVictoryScreen(message) {
            // Massive particle celebration
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createParticles('light', 100);
                    createParticles('star', 80);
                    createParticles('magic', 60);
                }, i * 500);
            }
            
            // Show victory screen after particles
            setTimeout(() => {
                const victoryScreen = document.getElementById('victoryScreen');
                const victoryMessage = document.getElementById('victoryMessage');
                
                // Extract guide's message from the result
                const lines = message.split('\n');
                const guideMessage = lines.slice(5).join('\n'); // Skip the animation description
                
                victoryMessage.innerHTML = formatMessage(guideMessage);
                victoryScreen.style.display = 'block';
            }, 2000);
        }

        // Add to History
        function addToHistory(message, className = '') {
            const history = document.getElementById('commandHistory');
            const entry = document.createElement('div');
            entry.className = `command-entry ${className}`;
            entry.innerHTML = formatMessage(message);
            history.appendChild(entry);
            history.scrollTop = history.scrollHeight;
        }

        // Format Message - 增强换行处理
        function formatMessage(message) {
            let formatted = message;
            
            // Visual effects
            formatted = formatted.replace(/\[([^\]]+)\]/g, '<span class="visual-effect">[$1]</span>');
            
            // Philosophical text in 「」
            formatted = formatted.replace(/「([\s\S]+?)」/g, '<span class="npc-dialogue">$1</span>');
            
            // Hint text in parentheses - 换行处理
            formatted = formatted.replace(/(\([^)]*\))/g, function(match) {
                if (!match.includes('<span')) {
                    const escapedMatch = match.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `<br><span class="hint-text">${escapedMatch}</span>`;
                }
                return match;
            });
            
            // Player dialogue - with line break
            formatted = formatted.replace(/^(You:.*?)$/gm, '<div class="player-dialogue">$1</div>');
            
            // NPC dialogue - match "Name: text" pattern and add line breaks
            formatted = formatted.replace(/^([A-Z][^:]*?):\s*(.*)$/gm, function(match, name, text) {
                // Don't format if it's already in a span
                if (match.includes('<span')) return match;
                // Don't format if it's a system message
                if (['Item added', 'Inventory', 'Congratulations', 'You see', 'Exits'].some(prefix => match.startsWith(prefix))) {
                    return match;
                }
                return `<div class="npc-dialogue">${name}: ${text}</div>`;
            });
            
            // 特殊处理：确保某些文本换行并标黄
            formatted = formatted.replace(/You must retrieve the six symbols—Courage, Freedom, Wisdom, Creation, Grit, and Love—to restore the stone disk\./g, 
                '<div class="npc-dialogue">You must retrieve the six symbols—Courage, Freedom, Wisdom, Creation, Grit, and Love—to restore the stone disk.</div>');
            formatted = formatted.replace(/Only then can the gate to self-completion be opened\./g, 
                '<div class="npc-dialogue">Only then can the gate to self-completion be opened.</div>');
            formatted = formatted.replace(/Oh, and one more thing—there is also a poor little bird in this cave\. This bird too fell into the cave in childhood\. Take her with you, and walk toward the light together!/g, 
                '<div class="npc-dialogue">Oh, and one more thing—there is also a poor little bird in this cave. This bird too fell into the cave in childhood. Take her with you, and walk toward the light together!</div>');
            
            return formatted;
        }

        // Show Help
        function showHelp() {
            addToHistory("🎮 Operation Guide:", "system-message");
            addToHistory("• 🖱️ Click on NPCs to talk with them", "system-message");
            addToHistory("• ✋ Click on items to pick up or interact", "system-message");
            addToHistory("• 🧭 Click direction arrows to move between rooms", "system-message");
            addToHistory("• 💡 In the cave, double-click the flashlight in your inventory to use it", "system-message");
            addToHistory("• 🕊️ In the forest, double-click the bird in your inventory to release it", "system-message");
            addToHistory("• 📚 In the library, click the 4 wisdom icons to explore", "system-message");
            addToHistory("• 🎭 In the theater, click stage options to create", "system-message");
            addToHistory("• 💪 On the slope, click the stone to push (requires 5 times)", "system-message");
            addToHistory("• 🌹 In the garden, talk to roses then choose", "system-message");
        }

        // Utility Functions
        function adjustColor(color, amount) {
            const clamp = (num) => Math.min(255, Math.max(0, num));
            const hex = color.replace(/^#/, '');
            const num = parseInt(hex, 16);
            const r = clamp((num >> 16) + amount);
            const g = clamp(((num >> 8) & 0x00FF) + amount);
            const b = clamp((num & 0x0000FF) + amount);
            return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
        }

        // Start Game
        window.onload = function() {
            initGame();
            document.getElementById('commandInput').focus();
        };

        window.onbeforeunload = function() {
            cancelAnimationFrame(animationFrame);
        };
    </script>
</body>
</html>

